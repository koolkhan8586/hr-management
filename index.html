import React, { useState, useEffect, useRef } from 'react';
import { 
  MapPin, Clock, Calendar, User, Home, LogOut, CheckCircle2, 
  AlertCircle, ChevronRight, Briefcase, Menu, X, DollarSign, 
  Heart, Users, Search, FileText, Download, Shield, Activity,
  Upload, FileSpreadsheet, Table, Eye, Wallet, ArrowLeft, Pencil, Trash2, Lock, Key, ShieldAlert, Save, Mail, MessageSquare, Send, Reply, Bell
} from 'lucide-react';

const API_BASE = '/api'; 
const COMPANY_NAME = "Lahore School of Accountancy";
const LOGO_URL = "/UOL-Green-V1.png";

/**
 * CORE DIAGNOSTIC SYSTEM
 */
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, info) { console.error("CRITICAL FAILURE:", error, info); }
  render() {
    if (this.state.hasError) {
      return (
        <div className="p-10 bg-red-50 min-h-screen font-mono flex items-center justify-center">
          <div className="bg-white p-8 rounded-3xl shadow-2xl border-2 border-red-200 max-w-lg w-full">
            <h1 className="text-red-600 text-xl font-black mb-4 uppercase">System Identity Failure</h1>
            <p className="text-slate-600 mb-6">Internal Matrix Error Detected.</p>
            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="w-full bg-red-600 text-white py-4 rounded-xl font-bold uppercase tracking-widest">Reboot & Clear Cache</button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

/**
 * UTILS
 */
function cleanNumber(val) {
  if (val === undefined || val === null || val === '' || isNaN(val)) return 0;
  return parseFloat(val);
}

function getInitial(name) { return name ? String(name).charAt(0).toUpperCase() : '?'; }
function formatDate(d) { return d ? new Date(d).toLocaleDateString() : 'N/A'; }
function getPktTime() { return new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Karachi', hour: '2-digit', minute: '2-digit', hour12: true }); }
function getPktDate() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Karachi' }); }

/**
 * COMPONENTS
 */
function Button({ children, onClick, variant = 'primary', className = '', disabled = false, icon: Icon, type = "button" }) {
  const base = "flex items-center justify-center gap-2 px-6 py-2.5 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 text-sm";
  const styles = {
    primary: "bg-green-700 text-white shadow-md hover:bg-green-800",
    secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
    danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100"
  };
  return <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className}`}>{Icon && <Icon size={18} />}{children}</button>;
}

function Badge({ status }) {
  const styles = { Approved: 'bg-green-100 text-green-700', Pending: 'bg-amber-100 text-amber-700', Rejected: 'bg-red-100 text-red-700' };
  return <span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-widest ${styles[status] || 'bg-slate-100 text-slate-600'}`}>{status}</span>;
}

/**
 * VIEWS
 */

function LoginView({ onLogin, loading }) {
  const [id, setId] = useState('');
  const [password, setPassword] = useState('');
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4 font-sans text-center">
      <div className="bg-white w-full max-w-md p-12 rounded-[2.5rem] shadow-2xl animate-slide-up border border-slate-100">
        <img src={LOGO_URL} alt="LSAF" className="h-16 mx-auto mb-6 object-contain" />
        <h1 className="text-xl font-black text-slate-800 uppercase tracking-widest">LSAFHR Port</h1>
        <p className="text-slate-400 text-xs mt-2 font-bold uppercase tracking-widest mb-8">Access Matrix v5.0</p>
        <form onSubmit={(e) => { e.preventDefault(); onLogin(id, password); }} className="space-y-4 text-left">
          <div>
            <label className="text-[10px] font-black uppercase text-slate-400 ml-2">ID</label>
            <input type="text" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold uppercase outline-none focus:bg-white focus:border-green-600" value={id} onChange={e => setId(e.target.value)} required placeholder="EMP001" />
          </div>
          <div>
            <label className="text-[10px] font-black uppercase text-slate-400 ml-2">Key</label>
            <input type="password" name="password" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold outline-none focus:bg-white focus:border-green-600" value={password} onChange={e => setPassword(e.target.value)} required placeholder="••••••••" />
          </div>
          <Button type="submit" disabled={loading} className="w-full py-4 mt-2">{loading ? 'Syncing...' : 'Initialize Session'}</Button>
        </form>
      </div>
    </div>
  );
}

function PayrollView({ user, employees, onEditEmployee, fetchData, payrollPostedMonths }) {
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
  const isAdmin = user.role === 'admin';
  const isPosted = payrollPostedMonths.some(m => String(m).trim() === String(month).trim());

  const calculateSalaryMetrics = (emp) => {
    if (!emp) return { totalAdd: 0, totalSub: 0, netPaid: 0 };
    const add = cleanNumber(emp.basic_salary) + cleanNumber(emp.invigilation) + cleanNumber(emp.t_payment) + cleanNumber(emp.increment) + cleanNumber(emp.eidi);
    const sub = cleanNumber(emp.extra_leaves_deduction) + cleanNumber(emp.tax) + cleanNumber(emp.loan_deduction) + cleanNumber(emp.insurance) + cleanNumber(emp.others_deduction);
    return { totalAdd: add, totalSub: sub, netPaid: add - sub };
  };

  const handleWipe = async () => {
    if (!window.confirm("CRITICAL: Wipe ALL staff month figures?")) return;
    const resets = employees.map(emp => ({ 
        ...emp, basic_salary: 0, invigilation: 0, t_payment: 0, increment: 0, 
        extra_leaves_deduction: 0, tax: 0, loan_deduction: 0, insurance: 0, 
        others_deduction: 0, eidi: 0 
    }));
    for (let emp of resets) { await onEditEmployee(emp, true); }
    await fetchData(); alert("Monthly Ledger Cleared.");
  };

  const handleReset = async (id) => {
    if (!window.confirm(`Reset month figures for employee ${id}?`)) return;
    const emp = employees.find(e => e.id === id);
    if (!emp) return;
    const payload = { ...emp, basic_salary: 0, invigilation: 0, t_payment: 0, increment: 0, extra_leaves_deduction: 0, tax: 0, loan_deduction: 0, insurance: 0, others_deduction: 0, eidi: 0 };
    await onEditEmployee(payload, true);
    await fetchData();
  };

  const handlePublish = async (currentlyPosted) => {
    const action = currentlyPosted ? 'DELETE' : 'POST';
    const body = currentlyPosted ? null : JSON.stringify({ month });
    const res = await fetch(`${API_BASE}/payroll-post${currentlyPosted ? '/' + month : ''}`, { method: action, headers: {'Content-Type':'application/json'}, body });
    if (res.ok) { fetchData(); }
  };

  const displayList = isAdmin ? employees : [employees.find(e => e.id === user.id) || user];

  return (
    <div className="space-y-6 animate-fade-in text-left">
      <div className="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4">
        <h2 className="text-xl font-black uppercase tracking-widest text-slate-800">Salary Hub</h2>
        <div className="flex gap-2">
          <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="p-2 border-2 rounded-xl font-black outline-none focus:border-green-600 bg-white" />
          {isAdmin && (
            <>
              <Button onClick={() => handlePublish(isPosted)} variant={isPosted ? 'danger' : 'primary'}>{isPosted ? 'Unpublish' : 'Publish'}</Button>
              <Button onClick={handleWipe} variant="danger">Wipe Month</Button>
            </>
          )}
        </div>
      </div>

      {!isAdmin && !isPosted ? (
        <div className="py-40 text-center bg-white rounded-[3rem] border border-slate-100 shadow-sm">
           <Lock size={64} className="mx-auto text-slate-100 mb-6" />
           <h3 className="text-xl font-black uppercase text-slate-300 tracking-widest">Period Unauthorized</h3>
           <p className="text-slate-400 text-sm">Waiting for admin broadcast for {month}.</p>
        </div>
      ) : (
        <div className="overflow-x-auto rounded-3xl border shadow-xl bg-white">
          <table className="w-full text-left text-[11px] font-sans">
            <thead className="bg-slate-50 border-b font-black text-slate-400 uppercase tracking-widest">
              <tr>
                <th className="p-5">ID</th><th className="p-5">Name</th>
                <th className="p-5 text-right">Basic</th><th className="p-5 text-right">Invig</th>
                <th className="p-5 text-right">Incr</th><th className="p-5 text-right">Tax</th>
                <th className="p-5 text-right font-black text-slate-900 uppercase">Net Paid</th>
                {isAdmin && <th className="p-5 text-center">Action</th>}
              </tr>
            </thead>
            <tbody className="divide-y font-bold">
              {displayList.map(emp => {
                const isEditing = editingId === emp.id;
                const m = calculateSalaryMetrics(isEditing ? editForm : emp);
                return (
                  <tr key={emp.id} className="hover:bg-slate-50 transition-colors">
                    <td className="p-5 font-black">{emp.id}</td>
                    <td className="p-5 uppercase truncate max-w-[150px]">{emp.name}</td>
                    <td className="p-5 text-right font-mono">{isEditing ? <input type="number" className="w-20 border rounded p-1" value={editForm.basic_salary} onChange={e=>setEditForm({...editForm, basic_salary:e.target.value})}/> : cleanNumber(emp.basic_salary).toLocaleString()}</td>
                    <td className="p-5 text-right font-mono">{isEditing ? <input type="number" className="w-16 border rounded p-1" value={editForm.invigilation} onChange={e=>setEditForm({...editForm, invigilation:e.target.value})}/> : cleanNumber(emp.invigilation).toLocaleString()}</td>
                    <td className="p-5 text-right font-mono">{isEditing ? <input type="number" className="w-16 border rounded p-1" value={editForm.increment} onChange={e=>setEditForm({...editForm, increment:e.target.value})}/> : cleanNumber(emp.increment).toLocaleString()}</td>
                    <td className="p-5 text-right font-mono">{isEditing ? <input type="number" className="w-16 border rounded p-1" value={editForm.tax} onChange={e=>setEditForm({...editForm, tax:e.target.value})}/> : cleanNumber(emp.tax).toLocaleString()}</td>
                    <td className="p-5 text-right font-black text-slate-900 uppercase tracking-tighter">Rs. {m.netPaid.toLocaleString()}</td>
                    {isAdmin && (
                      <td className="p-5 text-center">
                        {isEditing ? (
                          <button onClick={async () => { await onEditEmployee(editForm, true); setEditingId(null); await fetchData(); }} className="text-green-600 font-black text-[10px] border-b-2 border-green-600 uppercase">Save</button>
                        ) : (
                          <div className="flex justify-center gap-2">
                            <button onClick={() => { setEditingId(emp.id); setEditForm({...emp}); }} className="text-blue-500 hover:scale-125 transition-transform"><Pencil size={16}/></button>
                            <button onClick={() => handleReset(emp.id)} className="text-red-400 hover:scale-125 transition-transform"><Trash2 size={16}/></button>
                          </div>
                        )}
                      </td>
                    )}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

function DirectoryView({ employees, onAddMember, onEditMember, onDeleteMember }) {
  const [isOpen, setIsOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [form, setForm] = useState({ id: '', name: '', email: '', password: '', role: 'employee', leave_annual: 14, leave_casual: 10, loan_opening_balance: 0 });

  const submit = async (e) => {
    e.preventDefault();
    if (editingId) await onEditMember(form); else await onAddMember(form);
    setIsOpen(false); setEditingId(null); setForm({ id: '', name: '', email: '', password: '', role: 'employee', leave_annual: 14, leave_casual: 10, loan_opening_balance: 0 });
  };

  const edit = (emp) => {
    setEditingId(emp.id); setForm(emp); setIsOpen(true);
  };

  return (
    <div className="space-y-6 animate-fade-in text-left">
      <div className="flex justify-between items-center border-b pb-4">
        <h2 className="text-xl font-black uppercase tracking-widest text-slate-800">Staff Hub</h2>
        <Button onClick={() => setIsOpen(true)} icon={User}>Add Identity</Button>
      </div>

      {isOpen && (
        <Card className="border-2 border-green-100 animate-slide-up shadow-xl !p-10">
          <form onSubmit={submit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 font-sans">
             <div><label className="text-[10px] font-black uppercase text-slate-400 ml-2">ID</label><input type="text" disabled={!!editingId} className="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 uppercase" value={form.id} onChange={e => setForm({...form, id: e.target.value})} required /></div>
             <div><label className="text-[10px] font-black uppercase text-slate-400 ml-2">Name</label><input type="text" className="w-full p-4 rounded-xl border-2 font-bold bg-slate-50" value={form.name} onChange={e => setForm({...form, name: e.target.value})} required /></div>
             <div><label className="text-[10px] font-black uppercase text-slate-400 ml-2">Key</label><input type="text" className="w-full p-4 rounded-xl border-2 font-bold bg-slate-50" value={form.password} onChange={e => setForm({...form, password: e.target.value})} required /></div>
             <div><label className="text-[10px] font-black uppercase text-slate-400 ml-2">Opening Loan</label><input type="number" className="w-full p-4 rounded-xl border-2 font-bold bg-slate-50" value={form.loan_opening_balance} onChange={e => setForm({...form, loan_opening_balance: e.target.value})} /></div>
             <div className="md:col-span-2 lg:col-span-4 flex justify-end gap-3 pt-6 border-t">
                <Button variant="secondary" onClick={() => {setIsOpen(false); setEditingId(null);}}>Discard</Button>
                <Button type="submit">Sync Identity</Button>
             </div>
          </form>
        </Card>
      )}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {employees.map(emp => (
          <Card key={emp.id} className="flex items-center gap-4 group hover:border-green-300 transition-all text-left">
            <div className="h-12 w-12 rounded-xl bg-green-50 text-green-700 flex items-center justify-center font-black text-xl uppercase leading-none">{getInitial(emp.name)}</div>
            <div className="flex-1 overflow-hidden">
               <h4 className="font-black text-slate-800 uppercase truncate leading-none mb-1 text-sm">{emp.name}</h4>
               <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{emp.id} • {emp.role}</p>
               <p className="text-[9px] font-black text-red-500 uppercase mt-2">Opening Loan: Rs. {cleanNumber(emp.loan_opening_balance).toLocaleString()}</p>
            </div>
            <div className="opacity-0 group-hover:opacity-100 flex gap-1 transition-all">
               <button onClick={() => edit(emp)} className="text-blue-500 p-2 hover:bg-blue-50 rounded-lg"><Pencil size={16}/></button>
               <button onClick={() => onDeleteMember(emp.id)} className="text-red-500 p-2 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}

/**
 * MAIN ORCHESTRATION
 */
export default function App() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [employees, setEmployees] = useState([]);
  const [history, setHistory] = useState([]);
  const [loans, setLoans] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [discussions, setDiscussions] = useState([]);
  const [payrollPostedMonths, setPayrollPostedMonths] = useState([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(() => {
    try { const saved = localStorage.getItem('hr_user'); return saved ? JSON.parse(saved) : null; } catch(e) { return null; }
  });

  const syncState = async () => {
    try {
      const [eRes, pRes, lRes, dRes] = await Promise.all([
        fetch(API_BASE + '/employees'), fetch(API_BASE + '/payroll-posted'),
        fetch(API_BASE + '/loans'), fetch(API_BASE + '/discussions')
      ]);
      if (eRes.ok) setEmployees(await eRes.json());
      if (pRes.ok) setPayrollPostedMonths(await pRes.json());
      if (lRes.ok) setLoans(await lRes.json());
      if (dRes.ok) setDiscussions(await dRes.json());
    } catch (e) {} finally { setLoading(false); }
  };

  useEffect(() => { syncState(); }, []);

  const authHandle = async (id, password) => {
    setLoading(true);
    try {
      const res = await fetch(API_BASE + '/employees');
      const list = await res.json();
      const found = list.find(e => String(e.id).toUpperCase() === String(id).toUpperCase() && String(e.password) === String(password));
      if (found) {
        setUser(found); 
        localStorage.setItem('hr_user', JSON.stringify(found)); 
        await syncState();
      } else alert("Verification Failed.");
    } catch (e) { alert("Matrix offline."); } 
    finally { setLoading(false); }
  };

  const logout = () => { localStorage.removeItem('hr_user'); window.location.reload(); };

  const updateProfile = async (data, silent = false) => {
    const res = await fetch(`${API_BASE}/employees/${data.id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
    if (res.ok && !silent) await syncState();
  };

  if (loading && !user) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center gap-6 bg-white animate-pulse">
        <Activity size={64} className="text-green-700 animate-spin" />
        <p className="font-black text-slate-300 uppercase tracking-[0.5em]">Establishing LSAF Matrix</p>
      </div>
    );
  }

  if (!user) return <ErrorBoundary><LoginView onLogin={authHandle} loading={loading} /></ErrorBoundary>;

  const activeUser = employees.find(e => String(e.id).toUpperCase() === String(user.id).toUpperCase()) || user;

  const getTabContent = () => {
    switch(currentView) {
      case 'dashboard': return <DashboardView user={activeUser} />;
      case 'payroll': return <PayrollView user={activeUser} employees={employees} onEditEmployee={updateProfile} fetchData={syncState} payrollPostedMonths={payrollPostedMonths} />;
      case 'directory': return <DirectoryView employees={employees} onAddMember={async d => { await fetch(API_BASE+'/employees', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); syncState(); }} onEditMember={updateProfile} onDeleteMember={async id => { if(window.confirm("Wipe identity?")) { await fetch(`${API_BASE}/employees/${id}`, {method:'DELETE'}); syncState(); }}} />;
      default: return <DashboardView user={activeUser} />;
    }
  };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900 overflow-x-hidden">
        <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed h-full z-50 shadow-sm text-left">
          <div className="p-8 border-b text-center">
             <img src={LOGO_URL} alt="LSAF" className="h-10 mx-auto mb-2 object-contain" />
             <span className="text-[9px] font-black text-green-700 uppercase tracking-widest">LSAFHR Core</span>
          </div>
          <nav className="flex-1 p-4 space-y-1">
             <button onClick={()=>setCurrentView('dashboard')} className={`w-full flex items-center gap-4 p-4 rounded-2xl font-bold transition-all ${currentView==='dashboard'?'bg-green-700 text-white shadow-lg':'text-slate-500 hover:bg-slate-50'}`}><Home size={20}/><span className="text-[11px] uppercase tracking-wider text-left">Home</span></button>
             <button onClick={()=>setCurrentView('payroll')} className={`w-full flex items-center gap-4 p-4 rounded-2xl font-bold transition-all ${currentView==='payroll'?'bg-green-700 text-white shadow-lg':'text-slate-500 hover:bg-slate-50'}`}><DollarSign size={20}/><span className="text-[11px] uppercase tracking-wider text-left">Salary Hub</span></button>
             {activeUser.role==='admin' && <button onClick={()=>setCurrentView('directory')} className={`w-full flex items-center gap-4 p-4 rounded-2xl font-bold transition-all ${currentView==='directory'?'bg-green-700 text-white shadow-lg':'text-slate-500 hover:bg-slate-50'}`}><Users size={20}/><span className="text-[11px] uppercase tracking-wider text-left">Staff Hub</span></button>}
          </nav>
          <div className="p-6 border-t flex justify-between items-center text-left">
             <div className="overflow-hidden">
                <p className="font-black text-[11px] uppercase truncate">{activeUser.name}</p>
                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">{activeUser.role}</p>
             </div>
             <button onClick={logout} className="text-red-500 hover:bg-red-50 p-2 rounded-xl transition-all"><LogOut size={20}/></button>
          </div>
        </aside>
        <main className="flex-1 md:ml-64 p-6 md:p-12 pb-24">
           <div id="pdf-template" className="hidden fixed -left-[9999px] top-0 bg-white"></div>
           <div className="max-w-7xl mx-auto">{getTabContent()}</div>
        </main>
      </div>
    </ErrorBoundary>
  );
}
