<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSAFHR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Map Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-primary: #f8fafc;
            --text-primary: #0f172a;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }
        
        .dark-mode {
            --bg-primary: #0f172a;
            --text-primary: #f1f5f9;
            --card-bg: #1e293b;
            --border-color: #334155;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow-x: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark-mode .custom-scrollbar::-webkit-scrollbar-track { background: #334155; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark-mode .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        .loader { border-top-color: #15803d; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input[type="number"]::-webkit-inner-spin-button { display: none; }
        
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        #attendance-map { height: 450px; width: 100%; border-radius: 2.5rem; z-index: 10; border: 2px solid #f1f5f9; }
        .dark-mode #attendance-map { border-color: #334155; }
        
        .btn-clock-in {
            background-color: #427D48;
            color: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(66, 125, 72, 0.3);
            transition: all 0.2s;
            font-weight: 800;
        }
        .btn-clock-in:hover { background-color: #36663b; transform: translateY(-1px); }
        
        .btn-clock-out {
            background-color: white;
            color: #2D3E50;
            border: 2px solid #E2E8F0;
            border-radius: 1.25rem;
            transition: all 0.2s;
            font-weight: 800;
        }
        .dark-mode .btn-clock-out {
            background-color: #1e293b;
            color: #f1f5f9;
            border-color: #475569;
        }
        .btn-clock-out:hover { background-color: #f8fafc; }
        .dark-mode .btn-clock-out:hover { background-color: #334155; }
        
        .matrix-row:hover { background-color: #f8fafc; }
        .dark-mode .matrix-row:hover { background-color: #334155; }
        
        .status-badge { 
            font-weight: 900; 
            text-transform: uppercase; 
            font-size: 9px; 
            padding: 4px 10px; 
            border-radius: 8px; 
            letter-spacing: 0.05em; 
            display: inline-block; 
        }
        .status-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .dark-mode .status-pending { background-color: #78350f; color: #fef3c7; border-color: #92400e; }
        
        .status-approved { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .dark-mode .status-approved { background-color: #065f46; color: #dcfce7; border-color: #047857; }
        
        .status-rejected { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .dark-mode .status-rejected { background-color: #7f1d1d; color: #fee2e2; border-color: #991b1b; }
        
        .status-verified { background-color: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .dark-mode .status-verified { background-color: #1e3a8a; color: #eff6ff; border-color: #1e40af; }
        
        /* Dark mode classes */
        .dark-mode .bg-white { background-color: var(--card-bg) !important; }
        .dark-mode .bg-slate-50 { background-color: #334155 !important; }
        .dark-mode .bg-slate-100 { background-color: #475569 !important; }
        .dark-mode .text-slate-800 { color: #f1f5f9 !important; }
        .dark-mode .text-slate-400 { color: #cbd5e1 !important; }
        .dark-mode .text-slate-600 { color: #e2e8f0 !important; }
        .dark-mode .border-slate-100 { border-color: #475569 !important; }
        .dark-mode .border-slate-50 { border-color: #334155 !important; }
        .dark-mode .bg-slate-900 { background-color: #0f172a !important; }
        .dark-mode .bg-green-50 { background-color: #064e3b !important; }
        .dark-mode .bg-red-50 { background-color: #7f1d1d !important; }
        .dark-mode .bg-blue-50 { background-color: #1e3a8a !important; }
        .dark-mode .border-green-100 { border-color: #047857 !important; }
        .dark-mode .border-red-100 { border-color: #991b1b !important; }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .sr-only:focus {
            position: fixed;
            top: 0;
            left: 0;
            background: white;
            padding: 1rem;
            z-index: 9999;
            width: auto;
            height: auto;
            clip: auto;
        }
        
        .dark-mode .sr-only:focus {
            background: #1e293b;
            color: white;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-left text-[14px]">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only">Skip to main content</a>

    <!-- GLOBAL LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 bg-white dark:bg-slate-900 z-[999] flex flex-col items-center justify-center text-center">
        <div class="loader w-16 h-16 border-4 border-slate-100 dark:border-slate-700 border-t-green-700 rounded-full mb-4"></div>
        <p class="text-slate-400 dark:text-slate-500 font-black uppercase tracking-[0.3em] text-sm animate-pulse">Connecting to LSAFHR Matrix</p>
    </div>

    <!-- LOGIN INTERFACE -->
    <div id="login-container" class="hidden min-h-screen flex items-center justify-center p-4 bg-slate-100 dark:bg-slate-900 font-sans text-center text-left">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl border border-slate-100 dark:border-slate-700 animate-slide-up">
            <div class="text-center mb-10">
                <img src="UOL-Green-V1.png" alt="Logo" class="h-20 mx-auto mb-4 object-contain" onerror="this.src='https://placehold.co/150x150?text=LSAFHR'">
                <h1 class="text-2xl font-black text-slate-800 dark:text-slate-100 leading-tight uppercase tracking-widest">Lahore School of Accountancy</h1>
                <p class="text-slate-400 dark:text-slate-500 text-xs font-bold mt-2 uppercase tracking-widest">Management System v7.5.5</p>
            </div>
            <form id="login-form" class="space-y-5 text-left">
                <div class="space-y-1 text-left">
                    <label class="block text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase ml-2 tracking-widest">Employee ID</label>
                    <input type="text" id="login-id" class="w-full p-4 rounded-2xl border-2 border-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-white bg-slate-50 outline-none focus:border-green-500 focus:bg-white dark:focus:bg-slate-800 transition-all font-bold uppercase" placeholder="EMP001" required aria-label="Employee ID">
                </div>
                <div class="space-y-1 text-left">
                    <label class="block text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase ml-2 tracking-widest">System Key</label>
                    <input type="password" id="login-pass" class="w-full p-4 rounded-2xl border-2 border-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-white bg-slate-50 outline-none focus:border-green-500 focus:bg-white dark:focus:bg-slate-800 transition-all font-bold" placeholder="••••••••" required aria-label="Password">
                </div>
                <button type="submit" class="w-full bg-green-700 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:bg-green-800 transition-all mt-4 active:scale-95">Authorize Session</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP SHELL -->
    <div id="app-shell" class="hidden min-h-screen flex">
        <aside class="w-72 bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700 fixed h-full hidden lg:flex flex-col z-50 shadow-sm text-left">
            <div class="p-10 border-b border-slate-50 dark:border-slate-700 text-center">
                <img src="UOL-Green-V1.png" class="h-12 mx-auto mb-2 object-contain" alt="LSAFHR">
                <span class="text-[9px] font-black text-green-700 dark:text-green-400 uppercase tracking-widest">Identity Hub Matrix</span>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto custom-scrollbar" id="sidebar-nav"></nav>
            <div class="p-6 border-t border-slate-50 dark:border-slate-700 flex items-center justify-between" id="user-area">
                <div class="flex items-center gap-3 overflow-hidden text-left">
                    <div id="user-avatar" class="h-10 w-10 rounded-xl bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 flex items-center justify-center font-black text-sm uppercase">?</div>
                    <div class="flex flex-col overflow-hidden">
                        <span id="user-display-name" class="text-[11px] font-black truncate uppercase text-left"></span>
                        <span id="user-display-role" class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-tighter text-left">Verified</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="dark-mode-toggle" class="text-slate-400 dark:text-slate-300 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all">
                        <i data-lucide="moon" size="18"></i>
                    </button>
                    <button onclick="logout()" class="text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all">
                        <i data-lucide="log-out" size="18"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 lg:ml-72 p-6 md:p-12 pb-24 lg:pb-12 min-h-screen" id="main-content">
            <div id="view-container" class="max-w-full mx-auto text-left"></div>
        </main>

        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 p-4 flex justify-around shadow-2xl z-50 rounded-t-[2.5rem]">
            <button onclick="switchTab('dashboard')" class="p-4 rounded-2xl" id="mob-dashboard" aria-label="Dashboard"><i data-lucide="home"></i></button>
            <button onclick="switchTab('attendance')" class="p-4 rounded-2xl" id="mob-attendance" aria-label="Attendance"><i data-lucide="clock"></i></button>
            <button onclick="switchTab('payroll')" class="p-4 rounded-2xl" id="mob-payroll" aria-label="Payroll"><i data-lucide="dollar-sign"></i></button>
            <button onclick="switchTab('directory')" class="p-4 rounded-2xl" id="mob-directory" aria-label="Directory"><i data-lucide="users"></i></button>
            <button onclick="switchTab('loans')" class="p-4 rounded-2xl" id="mob-loans" aria-label="Loans"><i data-lucide="wallet"></i></button>
        </nav>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="status-toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[1000] bg-slate-900 dark:bg-slate-700 text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-2xl opacity-0 pointer-events-none transition-all duration-300 transform translate-y-[-20px] text-center">
        Status Updated
    </div>

    <!-- NOTIFICATION MODAL -->
    <div id="notification-modal" class="fixed inset-0 bg-black/50 z-[1001] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Notifications</h3>
                <button onclick="closeModal('notification-modal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div id="notification-list"></div>
        </div>
    </div>

    <!-- BACKUP MODAL -->
    <div id="backup-modal" class="fixed inset-0 bg-black/50 z-[1001] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Data Management</h3>
                <button onclick="closeModal('backup-modal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <div class="space-y-4">
                <button onclick="backupData()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition-all">
                    <i data-lucide="download" class="inline mr-2" size="18"></i> Backup Data
                </button>
                <div>
                    <label class="block text-sm font-bold mb-2">Restore Backup</label>
                    <input type="file" id="restore-file" accept=".json" class="w-full p-3 border-2 rounded-xl border-dashed border-slate-300 dark:border-slate-600" onchange="restoreData(this.files[0])">
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1'))
            ? 'http://localhost:5050/api'
            : '/api';

        let state = {
            user: null, employees: [], attendance: [], loans: [], discussions: [], leaves: [],
            allLeaves: [], allLoans: [], userLoans: [], userLeaves: [],
            payrollPostedMonths: [], currentTab: 'dashboard', 
            selectedMonth: new Date().toISOString().slice(0, 7),
            selectedAttendanceMonth: new Date().toISOString().slice(0, 7),
            selectedAdminEmployeeId: null,
            editingSalaryId: null, editingMemberId: null, editingAttendanceDate: null, 
            showManualEntryForm: false, map: null, leaveTab: 'apply', loanTab: 'apply',
            darkMode: localStorage.getItem('darkMode') === 'true',
            notifications: [],
            idleTimer: null
        };

        const NAV_ITEMS = [
            { id: 'dashboard', label: 'Home', icon: 'home', admin: false },
            { id: 'attendance', label: 'Attendance', icon: 'clock', admin: false },
            { id: 'payroll', label: 'Salary Hub', icon: 'dollar-sign', admin: false },
            { id: 'directory', label: 'Staff Hub', icon: 'users', admin: true },
            { id: 'loans', label: 'Loans Hub', icon: 'wallet', admin: false },
            { id: 'leaves', label: 'Leaves Hub', icon: 'calendar', admin: false },
            { id: 'discussion', label: 'Board', icon: 'message-square', admin: false }
        ];

        // --- INITIALIZATION ---
        window.onload = function() {
            // Apply dark mode
            if (state.darkMode) {
                document.body.classList.add('dark-mode');
            }
            
            // Initialize
            init();
            
            // Register service worker for offline support
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            }
            
            // Set up keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Set up offline detection
            setupOfflineDetection();
        };

        // --- CORE UTILITIES ---
        function notify(msg) {
            const t = document.getElementById('status-toast');
            if (!t) return;
            t.innerText = msg;
            t.style.opacity = '1';
            t.style.transform = 'translateY(0) translateX(-50%)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(-20px) translateX(-50%)';
            }, 4000);
        }

        function getPktTime() {
            return new Date().toLocaleTimeString('en-US', {
                timeZone: 'Asia/Karachi',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        function getPktDate() {
            return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Karachi' });
        }

        function cleanNumber(val) {
            const num = parseFloat(String(val || 0).replace(/[^0-9.-]+/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function formatDate(d) {
            return d ? new Date(d).toLocaleDateString('en-GB') : 'N/A';
        }

        function getInitial(name) {
            return name ? String(name).charAt(0).toUpperCase() : '?';
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validateEmployeeID(id) {
            return /^EMP\d{3,}$/.test(id);
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'SALT123'); // Add salt
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function calculateWorkTime(inTime, outTime) {
            if (!inTime || !outTime) return "0h 0m";
            try {
                const parseTime = (tStr) => {
                    const [time, modifier] = tStr.split(' ');
                    let [hours, minutes] = time.split(':');
                    if (hours === '12') hours = '00';
                    if (modifier === 'PM') hours = parseInt(hours, 10) + 12;
                    return new Date(2000, 0, 1, hours, minutes);
                };
                const diff = parseTime(outTime) - parseTime(inTime);
                if (diff < 0) return "0h 0m";
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                return `${h}h ${m}m`;
            } catch(e) {
                return "0h 0m";
            }
        }

        function calculateSalaryMetrics(emp) {
            if (!emp) return { netPaid: 0 };
            const add = cleanNumber(emp.basic_salary) + cleanNumber(emp.invigilation) + 
                       cleanNumber(emp.t_payment) + cleanNumber(emp.increment) + cleanNumber(emp.eidi);
            const sub = cleanNumber(emp.tax) + cleanNumber(emp.loan_deduction) + 
                       cleanNumber(emp.insurance) + cleanNumber(emp.others_deduction) + 
                       cleanNumber(emp.extra_leaves_deduction);
            return { netPaid: add - sub };
        }

        // --- SESSION MANAGEMENT ---
        function resetIdleTimer() {
            clearTimeout(state.idleTimer);
            if (state.user) {
                state.idleTimer = setTimeout(() => {
                    if (confirm('Session expired due to inactivity. Log out?')) {
                        logout();
                    }
                }, 30 * 60 * 1000); // 30 minutes
            }
        }

        // --- DARK MODE ---
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode', state.darkMode);
            localStorage.setItem('darkMode', state.darkMode);
            
            const icon = document.querySelector('#dark-mode-toggle i');
            if (icon) {
                icon.setAttribute('data-lucide', state.darkMode ? 'sun' : 'moon');
                lucide.createIcons();
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + key shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'd':
                            e.preventDefault();
                            switchTab('dashboard');
                            break;
                        case 'a':
                            e.preventDefault();
                            switchTab('attendance');
                            break;
                        case 's':
                            e.preventDefault();
                            switchTab('payroll');
                            break;
                        case 'l':
                            e.preventDefault();
                            if (e.shiftKey) logout();
                            break;
                        case 't':
                            e.preventDefault();
                            toggleDarkMode();
                            break;
                    }
                }
                
                // Escape key
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        // --- OFFLINE DETECTION ---
        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                notify("Back online. Syncing data...");
                syncData();
            });

            window.addEventListener('offline', () => {
                notify("You're offline. Some features may be limited.");
            });
        }

        // --- MODAL MANAGEMENT ---
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function closeAllModals() {
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        // --- INITIALIZATION ---
        async function init() {
            // Reset idle timer on user activity
            ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
                document.addEventListener(event, resetIdleTimer);
            });

            const saved = localStorage.getItem('hr_user');
            if (saved) {
                try {
                    state.user = JSON.parse(saved);
                    await syncData();
                    showApp();
                } catch (e) {
                    localStorage.removeItem('hr_user');
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
        }

        async function syncData() {
            if (!state.user) return;
            
            try {
                const isAdmin = state.user.role === 'admin';
                const endpoints = [
                    fetch(`${API_BASE}/employees`),
                    fetch(`${API_BASE}/payroll-posted`),
                    fetch(`${API_BASE}/discussions`),
                    fetch(`${API_BASE}/attendance/${state.user.id}`),
                    fetch(`${API_BASE}/leaves/${state.user.id}`),
                    fetch(`${API_BASE}/loans/${state.user.id}`),
                    isAdmin ? fetch(`${API_BASE}/admin/leaves`) : Promise.resolve({ ok: false }),
                    isAdmin ? fetch(`${API_BASE}/admin/loans`) : Promise.resolve({ ok: false })
                ];

                const responses = await Promise.allSettled(endpoints);
                
                // Process responses
                if (responses[0].status === 'fulfilled' && responses[0].value.ok) {
                    state.employees = await responses[0].value.json();
                }
                if (responses[1].status === 'fulfilled' && responses[1].value.ok) {
                    state.payrollPostedMonths = await responses[1].value.json();
                }
                if (responses[2].status === 'fulfilled' && responses[2].value.ok) {
                    state.discussions = await responses[2].value.json();
                }
                if (responses[3].status === 'fulfilled' && responses[3].value.ok) {
                    state.attendance = await responses[3].value.json();
                }
                if (responses[4].status === 'fulfilled' && responses[4].value.ok) {
                    state.userLeaves = await responses[4].value.json();
                }
                if (responses[5].status === 'fulfilled' && responses[5].value.ok) {
                    state.userLoans = await responses[5].value.json();
                }
                if (isAdmin) {
                    if (responses[6].status === 'fulfilled' && responses[6].value.ok) {
                        state.allLeaves = await responses[6].value.json();
                    }
                    if (responses[7].status === 'fulfilled' && responses[7].value.ok) {
                        state.allLoans = await responses[7].value.json();
                    }
                }

                // Update user data
                const fresh = state.employees.find(e => 
                    String(e.id).toUpperCase() === String(state.user.id).toUpperCase()
                );
                if (fresh) {
                    state.user = fresh;
                    localStorage.setItem('hr_user', JSON.stringify(fresh));
                }

            } catch (e) {
                console.warn("Sync Error", e);
                notify("Sync failed. Using cached data.");
            }
            
            document.getElementById('loading-screen').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-shell').classList.remove('hidden');
            
            // Update user info
            document.getElementById('user-display-name').innerText = state.user.name;
            document.getElementById('user-avatar').innerText = getInitial(state.user.name);
            
            // Set up dark mode toggle
            document.getElementById('dark-mode-toggle').onclick = toggleDarkMode;
            
            // Initial render
            renderSidebar();
            switchTab(state.currentTab);
            
            // Start idle timer
            resetIdleTimer();
            
            // Check for notifications
            checkNotifications();
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const isAdmin = state.user && state.user.role === 'admin';
            
            nav.innerHTML = NAV_ITEMS
                .filter(i => !i.admin || isAdmin)
                .map(i => `
                    <button onclick="switchTab('${i.id}')" 
                            class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-bold ${state.currentTab === i.id ? 'bg-green-700 text-white shadow-lg scale-105' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700'}">
                        <i data-lucide="${i.icon}" size="18"></i>
                        <span class="text-[11px] uppercase tracking-wider text-left">${i.label}</span>
                    </button>
                `).join('');
            
            lucide.createIcons();
        }

        function switchTab(id) {
            state.currentTab = id;
            state.editingSalaryId = null;
            state.editingMemberId = null;
            renderSidebar();
            renderView();
        }

        function renderView() {
            const container = document.getElementById('view-container');
            container.innerHTML = '<div class="py-40 text-center animate-pulse font-black text-slate-300 dark:text-slate-600 uppercase tracking-[0.5em]">Connecting to Hub...</div>';
            
            setTimeout(() => {
                switch(state.currentTab) {
                    case 'dashboard': renderDashboard(); break;
                    case 'payroll': renderPayroll(); break;
                    case 'directory': renderDirectory(); break;
                    case 'attendance': renderAttendance(); break;
                    case 'loans': renderLoans(); break;
                    case 'leaves': renderLeaves(); break;
                    case 'discussion': renderDiscussion(); break;
                    default: renderDashboard();
                }
                lucide.createIcons();
            }, 10);
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const container = document.getElementById('view-container');
            const now = new Date();
            const hours = now.getHours();
            let greeting = "Good ";
            if (hours < 12) greeting += "Morning";
            else if (hours < 18) greeting += "Afternoon";
            else greeting += "Evening";
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-8 text-slate-800 dark:text-slate-200">
                    <div class="flex justify-between items-center border-b pb-4 border-slate-100 dark:border-slate-700">
                        <div>
                            <h2 class="text-3xl font-black uppercase tracking-tighter">${greeting}, ${state.user.name.split(' ')[0]}</h2>
                            <p class="text-slate-400 dark:text-slate-500 text-sm mt-1">Welcome to your dashboard</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="document.getElementById('backup-modal').classList.remove('hidden')" 
                                    class="bg-white dark:bg-slate-800 p-3 rounded-xl border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                                    title="Data Management">
                                <i data-lucide="database" size="18"></i>
                            </button>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border shadow-sm text-right">
                                <p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase">Pakistan Time</p>
                                <p class="text-green-700 dark:text-green-400 font-black font-mono">${getPktTime()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-green-700 p-10 rounded-[3rem] text-white shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                            <p class="text-[10px] font-black uppercase opacity-60">Status Matrix</p>
                            <p class="text-3xl font-black mt-2 uppercase tracking-tighter">ACTIVE SESSION</p>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 p-10 rounded-[3rem] border-2 border-slate-100 dark:border-slate-700 shadow-sm">
                            <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Loan Outstanding</p>
                            <p class="text-4xl font-black text-red-500 dark:text-red-400 mt-2 font-mono">
                                Rs. ${cleanNumber(state.user.loan_opening_balance - state.user.loan_deduction).toLocaleString()}
                            </p>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 p-10 rounded-[3rem] border shadow-sm">
                            <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Identity Level</p>
                            <p class="text-2xl font-black capitalize">${state.user.role}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl border-2 border-slate-100 dark:border-slate-700">
                            <h3 class="text-lg font-black mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="switchTab('attendance')" class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left">
                                    <i data-lucide="clock" class="text-green-600 mb-2" size="24"></i>
                                    <p class="font-bold text-sm">Clock In/Out</p>
                                </button>
                                <button onclick="switchTab('leaves')" class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left">
                                    <i data-lucide="calendar" class="text-blue-600 mb-2" size="24"></i>
                                    <p class="font-bold text-sm">Apply Leave</p>
                                </button>
                                <button onclick="switchTab('loans')" class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left">
                                    <i data-lucide="wallet" class="text-purple-600 mb-2" size="24"></i>
                                    <p class="font-bold text-sm">Loan Request</p>
                                </button>
                                <button onclick="switchTab('payroll')" class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left">
                                    <i data-lucide="dollar-sign" class="text-yellow-600 mb-2" size="24"></i>
                                    <p class="font-bold text-sm">Salary View</p>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl border-2 border-slate-100 dark:border-slate-700">
                            <h3 class="text-lg font-black mb-4">Recent Activity</h3>
                            <div class="space-y-3">
                                ${state.attendance.slice(0, 3).map(log => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                                        <div>
                                            <p class="font-bold">${log.type}</p>
                                            <p class="text-xs text-slate-500">${log.date_str} • ${log.time_str}</p>
                                        </div>
                                        <span class="text-xs font-black px-2 py-1 rounded ${log.type === 'Clock In' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300'}">
                                            ${log.type}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- SALARY HUB ---
        async function renderPayroll() {
            const container = document.getElementById('view-container');
            const isAdmin = state.user && state.user.role === 'admin';
            const isPosted = state.payrollPostedMonths.includes(state.selectedMonth);
            
            let content = `
                <div class="animate-fade-in space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4 border-slate-100 dark:border-slate-700">
                        <h2 class="text-xl font-black uppercase tracking-widest">Salary Matrix Hub</h2>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <input type="month" value="${state.selectedMonth}" onchange="updateMonth(this.value)" 
                                   class="p-3 border-2 rounded-xl font-black bg-white dark:bg-slate-800 dark:text-white dark:border-slate-700 shadow-sm outline-none focus:border-green-600" />
                            ${isAdmin ? `
                                <button onclick="togglePublish(${isPosted})" 
                                        class="px-6 py-2.5 rounded-xl font-black text-[10px] text-white uppercase shadow-lg ${isPosted ? 'bg-red-600' : 'bg-slate-900 dark:bg-slate-700'}">
                                    ${isPosted ? 'Unpublish' : 'Publish'}
                                </button>
                                <button onclick="exportSalaryCSV()" 
                                        class="bg-slate-900 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                    Export CSV
                                </button>
                                <button onclick="exportToPDF('salary-table-container', 'Salary_Report_${state.selectedMonth}.pdf')" 
                                        class="bg-red-600 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                    Export PDF
                                </button>
                                <label class="bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300 px-6 py-2.5 rounded-xl font-black text-[10px] uppercase cursor-pointer hover:bg-green-100 dark:hover:bg-green-800 border-2 border-green-100 dark:border-green-800 flex items-center gap-2">
                                    <i data-lucide="upload" size="14"></i> Import CSV
                                    <input type="file" onchange="importSalaryCSV(this)" class="hidden" accept=".csv">
                                </label>
                                <button onclick="downloadSalarySample()" 
                                        class="bg-white dark:bg-slate-800 border-2 dark:border-slate-700 px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-sm">
                                    Sample CSV
                                </button>
                            ` : ''}
                        </div>
                    </div>`;

            if (!isAdmin && !isPosted) {
                content += `
                    <div class="py-40 text-center bg-white dark:bg-slate-800 rounded-[3rem] border-2 border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="bg-slate-50 dark:bg-slate-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="lock" class="text-slate-200 dark:text-slate-700" size="48"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-300 dark:text-slate-600 uppercase tracking-widest">Period Locked</h3>
                    </div>`;
            } else {
                content += `
                    <div id="salary-table-container" class="overflow-x-auto rounded-[2rem] bg-white dark:bg-slate-800 border-2 shadow-2xl dark:border-slate-700">
                        <table class="w-full text-left text-[9px]">
                            <thead class="bg-slate-50 dark:bg-slate-900 border-b font-black uppercase text-slate-400 dark:text-slate-500 tracking-widest">
                                <tr>
                                    <th class="p-4">ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4 text-right">Basic</th>
                                    <th class="p-4 text-right">Invig</th>
                                    <th class="p-4 text-right">T.Pay</th>
                                    <th class="p-4 text-right">Incr</th>
                                    <th class="p-4 text-right">Eidi</th>
                                    <th class="p-4 text-right text-slate-500">Tax</th>
                                    <th class="p-4 text-right text-slate-500">Loan</th>
                                    <th class="p-4 text-right text-slate-500">Ins.</th>
                                    <th class="p-4 text-right text-slate-500">Others</th>
                                    <th class="p-4 text-right text-red-500">L.Ded</th>
                                    <th class="p-4 text-right font-black text-slate-900 dark:text-slate-200 uppercase font-mono text-xs bg-slate-100/50 dark:bg-slate-900/50">Net Paid</th>
                                    ${isAdmin ? `<th class="p-4 text-center">Audit</th>` : ''}
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-slate-700 font-bold text-slate-800 dark:text-slate-200">`;

                const list = isAdmin ? state.employees : [state.employees.find(e => e.id === state.user.id) || state.user];
                list.forEach(emp => {
                    const isEditing = state.editingSalaryId === emp.id;
                    const m = calculateSalaryMetrics(emp);
                    content += `
                        <tr class="matrix-row transition-all">
                            <td class="p-4 font-black font-mono">${emp.id}</td>
                            <td class="p-4 truncate max-w-[100px] uppercase">${emp.name}</td>
                            <td class="p-4 text-right font-mono">
                                ${isEditing ? `<input type="number" id="eb-${emp.id}" class="w-16 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.basic_salary}">` : cleanNumber(emp.basic_salary).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono">
                                ${isEditing ? `<input type="number" id="ei-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.invigilation}">` : cleanNumber(emp.invigilation).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono">
                                ${isEditing ? `<input type="number" id="et-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.t_payment}">` : cleanNumber(emp.t_payment).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono">
                                ${isEditing ? `<input type="number" id="en-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.increment}">` : cleanNumber(emp.increment).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono">
                                ${isEditing ? `<input type="number" id="ed-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.eidi}">` : cleanNumber(emp.eidi).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono text-slate-500">
                                ${isEditing ? `<input type="number" id="ex-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.tax}">` : cleanNumber(emp.tax).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono text-slate-500">
                                ${isEditing ? `<input type="number" id="el-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.loan_deduction}">` : cleanNumber(emp.loan_deduction).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono text-slate-500">
                                ${isEditing ? `<input type="number" id="es-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.insurance}">` : cleanNumber(emp.insurance).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono text-slate-500">
                                ${isEditing ? `<input type="number" id="eo-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.others_deduction}">` : cleanNumber(emp.others_deduction).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-mono text-red-500 dark:text-red-400">
                                ${isEditing ? `<input type="number" id="eld-${emp.id}" class="w-12 border rounded p-1 text-right bg-white dark:bg-slate-900 dark:text-white" value="${emp.extra_leaves_deduction}">` : cleanNumber(emp.extra_leaves_deduction).toLocaleString()}
                            </td>
                            <td class="p-4 text-right font-black font-mono text-xs bg-slate-100/50 dark:bg-slate-900/50">
                                Rs. ${m.netPaid.toLocaleString()}
                            </td>
                            ${isAdmin ? `
                                <td class="p-4 text-center">
                                    ${isEditing ? 
                                        `<button onclick="saveSalary('${emp.id}')" class="text-green-600 bg-green-50 dark:bg-green-900 p-2 rounded-lg hover:bg-green-600 hover:text-white transition-all">
                                            <i data-lucide="save" size="14"></i>
                                        </button>` : 
                                        `<button onclick="state.editingSalaryId='${emp.id}'; renderPayroll()" class="text-blue-500 bg-blue-50 dark:bg-blue-900 p-2 rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                                            <i data-lucide="pencil" size="14"></i>
                                        </button>`}
                                </td>` : ''}
                        </tr>`;
                });
                content += `</tbody></table></div>`;
            }
            container.innerHTML = content + '</div>';
            lucide.createIcons();
        }

        async function saveSalary(id) {
            const payload = {
                basic_salary: cleanNumber(document.getElementById(`eb-${id}`).value),
                invigilation: cleanNumber(document.getElementById(`ei-${id}`).value),
                t_payment: cleanNumber(document.getElementById(`et-${id}`).value),
                increment: cleanNumber(document.getElementById(`en-${id}`).value),
                eidi: cleanNumber(document.getElementById(`ed-${id}`).value),
                tax: cleanNumber(document.getElementById(`ex-${id}`).value),
                loan_deduction: cleanNumber(document.getElementById(`el-${id}`).value),
                insurance: cleanNumber(document.getElementById(`es-${id}`).value),
                others_deduction: cleanNumber(document.getElementById(`eo-${id}`).value),
                extra_leaves_deduction: cleanNumber(document.getElementById(`eld-${id}`).value)
            };
            
            const res = await fetch(`${API_BASE}/employees/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                state.editingSalaryId = null;
                await syncData();
                renderPayroll();
                notify("Salary updated successfully");
            } else {
                notify("Failed to update salary");
            }
        }

        function downloadSalarySample() {
            const sample = [{
                "ID": "EMP100",
                "Name": "Staff Name",
                "Basic": 50000,
                "Invig": 0,
                "TPay": 0,
                "Incr": 0,
                "Eidi": 0,
                "Tax": 0,
                "Loan": 0,
                "Ins": 0,
                "Other": 0,
                "LDed": 0
            }];
            exportToCSV(sample, "Salary_Matrix_Sample.csv");
        }

        async function importSalaryCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                let successCount = 0;
                
                notify("Importing salary data...");
                
                for (let row of rows) {
                    const cols = row.split(',');
                    if (cols.length < 2) continue;
                    
                    const id = cols[0].replace(/"/g, '').trim().toUpperCase();
                    const payload = {
                        basic_salary: cleanNumber(cols[2]),
                        invigilation: cleanNumber(cols[3]),
                        t_payment: cleanNumber(cols[4]),
                        increment: cleanNumber(cols[5]),
                        eidi: cleanNumber(cols[6]),
                        tax: cleanNumber(cols[7]),
                        loan_deduction: cleanNumber(cols[8]),
                        insurance: cleanNumber(cols[9]),
                        others_deduction: cleanNumber(cols[10]),
                        extra_leaves_deduction: cleanNumber(cols[11])
                    };
                    
                    try {
                        const res = await fetch(`${API_BASE}/employees/${id}`, {
                            method: 'PUT',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        });
                        if (res.ok) successCount++;
                    } catch (err) {
                        console.error("Import error:", err);
                    }
                }
                
                notify(`Imported ${successCount} records successfully`);
                await syncData();
                renderPayroll();
            };
            reader.readAsText(file);
        }

        function exportSalaryCSV() {
            const data = state.employees.map(e => ({
                "ID": e.id,
                "Name": e.name,
                "Basic": e.basic_salary,
                "Invig": e.invigilation,
                "T.Pay": e.t_payment,
                "Incr": e.increment,
                "Eidi": e.eidi,
                "Tax": e.tax,
                "Loan": e.loan_deduction,
                "Ins": e.insurance,
                "Others": e.others_deduction,
                "L.Ded": e.extra_leaves_deduction,
                "Net Paid": calculateSalaryMetrics(e).netPaid
            }));
            exportToCSV(data, `LSAFHR_Salary_${state.selectedMonth}.csv`);
        }

        // --- ATTENDANCE HUB ---
        async function renderAttendance() {
            const container = document.getElementById('view-container');
            const isAdmin = state.user && state.user.role === 'admin';
            
            const dailyLogs = {};
            state.attendance
                .filter(l => l.date_str && l.date_str.startsWith(state.selectedAttendanceMonth))
                .forEach(l => {
                    if (!dailyLogs[l.date_str]) dailyLogs[l.date_str] = [];
                    dailyLogs[l.date_str].push(l);
                });
            
            const dateRows = Object.keys(dailyLogs).sort((a, b) => new Date(b) - new Date(a));
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4 border-slate-100 dark:border-slate-700">
                        <h2 class="text-xl font-black uppercase tracking-widest text-left">Attendance Hub</h2>
                        <div class="flex gap-2">
                            <input type="month" value="${state.selectedAttendanceMonth}" onchange="updateAttendanceMonth(this.value)" 
                                   class="p-3 border-2 rounded-xl font-black bg-white dark:bg-slate-800 dark:text-white dark:border-slate-700 shadow-sm outline-none focus:border-green-600" />
                            <button onclick="exportAttendanceCSV(${isAdmin})" 
                                    class="bg-slate-900 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                Export CSV
                            </button>
                            <button onclick="exportToPDF('attendance-table-container', 'Attendance_Report_${state.selectedAttendanceMonth}.pdf')" 
                                    class="bg-red-600 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] border-2 dark:border-slate-700 shadow-2xl relative overflow-hidden h-[450px]">
                        <div id="attendance-map" class="h-full w-full rounded-[2rem]"></div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] py-16 flex flex-col items-center justify-center space-y-8 border-2 border-dashed border-slate-100 dark:border-slate-700 shadow-inner bg-slate-50/50 dark:bg-slate-900/50">
                            <h3 class="text-7xl font-black font-mono tracking-tighter">${getPktTime()}</h3>
                            <div class="flex flex-col gap-4 w-full max-sm px-10">
                                <button onclick="handleClock('Clock In')" 
                                        class="w-full py-5 btn-clock-in text-base uppercase tracking-widest"
                                        aria-label="Clock In">
                                    Mark Clock In
                                </button>
                                <button onclick="handleClock('Clock Out')" 
                                        class="w-full py-5 btn-clock-out text-base uppercase tracking-widest"
                                        aria-label="Clock Out">
                                    Mark Clock Out
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-12 border-2 border-slate-50 dark:border-slate-700 text-center flex flex-col items-center justify-center">
                            <div class="bg-green-50 dark:bg-green-900 w-24 h-24 rounded-full flex items-center justify-center mb-8">
                                <i data-lucide="map-pin" class="text-green-600 dark:text-green-400 animate-bounce" size="40"></i>
                            </div>
                            <p class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase tracking-widest">Geofence Verified</p>
                        </div>
                    </div>
                    
                    <div id="attendance-table-container" class="bg-white dark:bg-slate-800 rounded-[2.5rem] border shadow-sm dark:border-slate-700 mt-8 overflow-hidden">
                        <div class="bg-slate-50 dark:bg-slate-900 p-6 border-b dark:border-slate-700 flex justify-between items-center">
                            <span class="font-black text-xs uppercase text-slate-500 dark:text-slate-400 tracking-widest">Attendance Summary</span>
                            <span class="text-[10px] font-black text-green-700 dark:text-green-400 uppercase tracking-tighter">Verified Logs</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 dark:bg-slate-900/50 text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 tracking-widest border-b dark:border-slate-700">
                                    <tr>
                                        <th class="p-6">Date</th>
                                        <th class="p-6 text-center">In Time</th>
                                        <th class="p-6 text-center">Out Time</th>
                                        <th class="p-6 text-center">Total Work</th>
                                        <th class="p-6 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-700 font-bold text-slate-800 dark:text-slate-200">
                                    ${dateRows.map(date => {
                                        const logs = dailyLogs[date];
                                        const cin = logs.find(l => l.type === 'Clock In');
                                        const cout = [...logs].reverse().find(l => l.type === 'Clock Out');
                                        return `
                                            <tr class="matrix-row transition-all">
                                                <td class="p-6 font-mono text-sm">${date}</td>
                                                <td class="p-6 text-center">
                                                    ${cin ? `
                                                        <button onclick="focusMap(${cin.latitude}, ${cin.longitude}, 'CLOCK IN', '${cin.time_str}')" 
                                                                class="text-green-600 dark:text-green-400 border-b-2 border-green-100 dark:border-green-900 uppercase text-[10px] font-black">
                                                            ${cin.time_str}
                                                        </button>` : 
                                                        '<span class="text-slate-200 dark:text-slate-700">--:--</span>'}
                                                </td>
                                                <td class="p-6 text-center">
                                                    ${cout ? `
                                                        <button onclick="focusMap(${cout.latitude}, ${cout.longitude}, 'CLOCK OUT', '${cout.time_str}')" 
                                                                class="text-red-600 dark:text-red-400 border-b-2 border-red-100 dark:border-red-900 uppercase text-[10px] font-black">
                                                            ${cout.time_str}
                                                        </button>` : 
                                                        '<span class="text-slate-200 dark:text-slate-700">--:--</span>'}
                                                </td>
                                                <td class="p-6 text-center font-black">${calculateWorkTime(cin?.time_str, cout?.time_str)}</td>
                                                <td class="p-6 text-center">
                                                    <div class="flex justify-center gap-4">
                                                        ${isAdmin ? `
                                                            <button onclick="wipeDateAttendance('${date}')" 
                                                                    class="bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-300 p-3 rounded-2xl hover:bg-red-600 transition-all hover:text-white"
                                                                    aria-label="Delete attendance for ${date}">
                                                                <i data-lucide="trash-2" size="18"></i>
                                                            </button>
                                                        ` : `
                                                            <span class="status-badge status-approved">Verified</span>
                                                        `}
                                                    </div>
                                                </td>
                                            </tr>`;
                                    }).join('')}
                                    ${dateRows.length === 0 ? `
                                        <tr>
                                            <td colspan="5" class="p-40 text-center font-black text-slate-300 dark:text-slate-600 uppercase tracking-widest">
                                                No Attendance Records
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            
            lucide.createIcons();
            
            // Initialize map
            setTimeout(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            initMap(pos.coords.latitude, pos.coords.longitude, "CURRENT POSITION");
                        },
                        () => {
                            initMap(31.5204, 74.3587, "Lahore School of Accountancy");
                        }
                    );
                } else {
                    initMap(31.5204, 74.3587, "Lahore School of Accountancy");
                }
            }, 300);
        }

        function initMap(lat, lng, label) {
            const mapContainer = document.getElementById('attendance-map');
            if (!mapContainer || !window.L) return;
            
            if (state.map) {
                state.map.remove();
            }
            
            state.map = window.L.map('attendance-map').setView([lat, lng], 15);
            
            window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(state.map);
            
            window.L.marker([lat, lng])
                .addTo(state.map)
                .bindPopup(`<p class="font-black text-[10px] uppercase">${label}</p>`)
                .openPopup();
        }

        function focusMap(lat, lng, action, time) {
            if (!state.map || !lat || !lng) return;
            
            state.map.setView([lat, lng], 17);
            window.L.marker([lat, lng])
                .addTo(state.map)
                .bindPopup(`<p class="font-black text-[10px] uppercase text-slate-800">${action}<br/><span class="text-green-700">${time}</span></p>`)
                .openPopup();
            
            window.scrollTo({ top: 150, behavior: 'smooth' });
            notify(`Focusing on ${time}`);
        }

        async function handleClock(type) {
            notify("Processing...");
            
            if (!navigator.geolocation) {
                notify("Geolocation not supported");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const payload = {
                    employee_id: state.user.id,
                    type: type,
                    date_str: getPktDate(),
                    time_str: getPktTime(),
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude
                };
                
                try {
                    const res = await fetch(`${API_BASE}/attendance`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) {
                        notify(`${type} recorded successfully`);
                        await syncData();
                        if (state.currentTab === 'attendance') {
                            renderAttendance();
                        }
                    } else {
                        notify("Failed to record attendance");
                    }
                } catch (error) {
                    notify("Network error. Please try again.");
                }
            }, () => {
                notify("Location access denied. Please enable location services.");
            });
        }

        async function wipeDateAttendance(date) {
            if (!confirm(`Delete all attendance records for ${date}? This action cannot be undone.`)) {
                return;
            }
            
            const targetId = (state.user.role === 'admin' && state.selectedAdminEmployeeId) 
                ? state.selectedAdminEmployeeId 
                : state.user.id;
            
            const logs = state.attendance.filter(l => 
                l.date_str === date && l.employee_id === targetId
            );
            
            let deletedCount = 0;
            for (let log of logs) {
                try {
                    const res = await fetch(`${API_BASE}/attendance-entry/${log.id}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) deletedCount++;
                } catch (error) {
                    console.error("Delete error:", error);
                }
            }
            
            notify(`Deleted ${deletedCount} records for ${date}`);
            await syncData();
            renderAttendance();
        }

        // --- STAFF DIRECTORY ---
        function renderDirectory() {
            const container = document.getElementById('view-container');
            const isAdmin = state.user && state.user.role === 'admin';
            
            if (!isAdmin) {
                container.innerHTML = `
                    <div class="py-40 text-center">
                        <div class="bg-slate-50 dark:bg-slate-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="shield-off" class="text-slate-200 dark:text-slate-700" size="48"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-300 dark:text-slate-600 uppercase tracking-widest">Admin Access Required</h3>
                    </div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4 border-slate-100 dark:border-slate-700">
                        <h2 class="text-xl font-black uppercase tracking-widest">Staff Directory</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadDirectorySample()" 
                                    class="bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-sm">
                                Sample CSV
                            </button>
                            <button onclick="toggleStaffForm()" 
                                    class="bg-green-700 text-white px-6 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                Add Employee
                            </button>
                        </div>
                    </div>
                    
                    <div id="staff-form-area"></div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${state.employees.map(emp => `
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-2 border-slate-50 dark:border-slate-700 flex flex-col items-center gap-4 hover:border-green-300 dark:hover:border-green-600 transition-all group text-center relative overflow-hidden">
                                <div class="h-12 w-12 bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-xl flex items-center justify-center font-black text-xl uppercase">
                                    ${getInitial(emp.name)}
                                </div>
                                <div class="w-full">
                                    <h4 class="font-black text-slate-800 dark:text-slate-200 uppercase truncate text-sm mb-1">${emp.name}</h4>
                                    <p class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">
                                        ${emp.id} • ${emp.role}
                                    </p>
                                    <p class="text-[9px] font-black text-red-400 dark:text-red-300 mt-2">
                                        Loan Balance: Rs. ${cleanNumber(emp.loan_opening_balance).toLocaleString()}
                                    </p>
                                </div>
                                <div class="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition-all">
                                    <button onclick="editStaff('${emp.id}')" 
                                            class="text-blue-500 dark:text-blue-400 p-2 hover:bg-blue-50 dark:hover:bg-blue-900 rounded-lg transition-all"
                                            aria-label="Edit ${emp.name}">
                                        <i data-lucide="pencil" size="18"></i>
                                    </button>
                                    <button onclick="deleteStaff('${emp.id}')" 
                                            class="text-red-400 dark:text-red-300 p-2 hover:bg-red-50 dark:hover:bg-red-900 rounded-lg transition-all"
                                            aria-label="Delete ${emp.name}">
                                        <i data-lucide="trash-2" size="18"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            lucide.createIcons();
        }

        function toggleStaffForm(emp = null) {
            const area = document.getElementById('staff-form-area');
            
            if (!emp && area.innerHTML && !state.editingMemberId) {
                area.innerHTML = '';
                return;
            }
            
            state.editingMemberId = emp ? emp.id : null;
            
            area.innerHTML = `
                <div class="bg-white dark:bg-slate-800 p-10 rounded-[2.5rem] border-2 border-green-100 dark:border-green-900 shadow-2xl mb-10 animate-slide-up relative">
                    <button onclick="toggleStaffForm()" 
                            class="absolute top-6 right-6 text-slate-300 dark:text-slate-600 hover:text-red-500 transition-all"
                            aria-label="Close form">
                        <i data-lucide="x" size="32"></i>
                    </button>
                    
                    <form onsubmit="handleStaffSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-1 block">Employee ID</label>
                            <input type="text" id="s-id" 
                                   class="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                   value="${emp ? emp.id : ''}" 
                                   ${emp ? 'readonly' : 'required'}
                                   placeholder="EMP001"
                                   pattern="EMP\d{3,}"
                                   title="Format: EMP followed by numbers (e.g., EMP001)">
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-1 block">Full Name</label>
                            <input type="text" id="s-name" 
                                   class="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                   value="${emp ? emp.name : ''}" 
                                   required
                                   placeholder="John Doe">
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-1 block">Email Address</label>
                            <input type="email" id="s-email" 
                                   class="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                   value="${emp ? emp.email : ''}" 
                                   required
                                   placeholder="john@example.com">
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-1 block">Password</label>
                            <input type="text" id="s-pass" 
                                   class="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                   value="${emp ? emp.password : ''}" 
                                   required
                                   placeholder="Enter password">
                        </div>
                        
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-1 block">Loan Balance</label>
                            <input type="number" id="s-loan-open" 
                                   class="w-full p-4 rounded-xl border-2 font-bold bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                   value="${emp ? emp.loan_opening_balance : 0}"
                                   min="0"
                                   step="1000">
                        </div>
                        
                        <div class="md:col-span-2 lg:col-span-4 flex justify-end gap-3 pt-6 border-t dark:border-slate-700">
                            <button type="submit" 
                                    class="bg-green-700 text-white px-10 py-4 rounded-xl font-black uppercase text-xs shadow-lg hover:bg-green-800 transition-all">
                                ${emp ? 'Update Employee' : 'Create Employee'}
                            </button>
                        </div>
                    </form>
                </div>`;
            
            lucide.createIcons();
        }

        async function handleStaffSubmit(e) {
            e.preventDefault();
            
            const sid = document.getElementById('s-id').value.toUpperCase();
            const name = document.getElementById('s-name').value;
            const email = document.getElementById('s-email').value;
            const password = document.getElementById('s-pass').value;
            const loanBalance = cleanNumber(document.getElementById('s-loan-open').value);
            
            // Validation
            if (!validateEmployeeID(sid)) {
                notify("Invalid Employee ID. Use format: EMP followed by numbers (e.g., EMP001)");
                return;
            }
            
            if (!validateEmail(email)) {
                notify("Please enter a valid email address");
                return;
            }
            
            if (password.length < 4) {
                notify("Password must be at least 4 characters long");
                return;
            }
            
            const payload = {
                id: sid,
                name: name,
                email: email,
                password: password,
                loan_opening_balance: loanBalance,
                role: 'employee',
                leave_annual: 14,
                leave_casual: 10
            };
            
            const method = state.editingMemberId ? 'PUT' : 'POST';
            const url = state.editingMemberId 
                ? `${API_BASE}/employees/${state.editingMemberId}`
                : `${API_BASE}/employees`;
            
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    notify(state.editingMemberId ? "Employee updated successfully" : "Employee created successfully");
                    state.editingMemberId = null;
                    await syncData();
                    renderDirectory();
                } else {
                    notify("Failed to save employee");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        async function deleteStaff(id) {
            const emp = state.employees.find(e => e.id === id);
            if (!emp) return;
            
            if (!confirm(`Delete employee ${emp.name} (${emp.id})? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/employees/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    notify("Employee deleted successfully");
                    await syncData();
                    renderDirectory();
                } else {
                    notify("Failed to delete employee");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        function editStaff(id) {
            const emp = state.employees.find(e => e.id === id);
            if (emp) {
                toggleStaffForm(emp);
            }
        }

        function downloadDirectorySample() {
            const sample = [{
                "id": "EMP101",
                "name": "Staff Name",
                "email": "staff@example.com",
                "password": "password123",
                "loan_opening": 0,
                "role": "employee"
            }];
            exportToCSV(sample, "Employee_Sample.csv");
        }

        // --- LOANS HUB ---
        async function renderLoans() {
            const container = document.getElementById('view-container');
            const isAdmin = state.user && state.user.role === 'admin';
            const targetUser = state.employees.find(e => e.id === state.user.id) || state.user;
            
            const totalApproved = (state.userLoans || [])
                .filter(ln => ln.status === 'Approved')
                .reduce((acc, curr) => acc + cleanNumber(curr.amount), 0);
            
            const netOutstanding = cleanNumber(targetUser.loan_opening_balance) + 
                                 totalApproved - 
                                 cleanNumber(targetUser.loan_deduction);
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-700 shadow-sm">
                            <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Opening Balance</p>
                            <p class="text-2xl font-black mt-2 font-mono">Rs. ${cleanNumber(targetUser.loan_opening_balance).toLocaleString()}</p>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900 p-8 rounded-[2.5rem] border-2 border-green-100 dark:border-green-800">
                            <p class="text-[9px] font-black text-green-700 dark:text-green-400 uppercase tracking-widest">Approved Amount</p>
                            <p class="text-2xl font-black mt-2 font-mono text-green-800 dark:text-green-300">Rs. ${totalApproved.toLocaleString()}</p>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-700 shadow-sm">
                            <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Monthly Deduction</p>
                            <p class="text-2xl font-black mt-2 font-mono">Rs. ${cleanNumber(targetUser.loan_deduction).toLocaleString()}</p>
                        </div>
                        
                        <div class="bg-red-50 dark:bg-red-900 p-8 rounded-[2.5rem] border-2 border-red-100 dark:border-red-800">
                            <p class="text-[9px] font-black text-red-600 dark:text-red-400 uppercase tracking-widest">Net Balance</p>
                            <p class="text-2xl font-black mt-2 font-mono text-red-600 dark:text-red-300">Rs. ${netOutstanding.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="flex bg-slate-200 dark:bg-slate-700 p-2 rounded-[2rem] max-w-sm mx-auto mb-10 shadow-inner">
                        <button onclick="state.loanTab='apply'; renderLoans()" 
                                class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase tracking-widest transition-all ${state.loanTab === 'apply' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                            Apply Loan
                        </button>
                        <button onclick="state.loanTab='history'; renderLoans()" 
                                class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase tracking-widest transition-all ${state.loanTab === 'history' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                            My History
                        </button>
                        ${isAdmin ? `
                            <button onclick="state.loanTab='oversight'; renderLoans()" 
                                    class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase transition-all ${state.loanTab === 'oversight' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                                Oversight
                            </button>
                        ` : ''}
                    </div>
                    
                    ${renderLoanContent(isAdmin, netOutstanding)}
                </div>`;
            
            lucide.createIcons();
        }

        function renderLoanContent(isAdmin, netOutstanding) {
            if (state.loanTab === 'oversight' && isAdmin) {
                return `
                    <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-2 border-slate-100 dark:border-slate-700 shadow-2xl overflow-hidden">
                        <div class="bg-slate-50 dark:bg-slate-900 p-8 border-b dark:border-slate-700 flex justify-between items-center">
                            <span class="font-black text-xs uppercase text-slate-500 dark:text-slate-400 tracking-widest">Loan Applications</span>
                            <button onclick="exportToCSV(state.allLoans, 'Loans_Oversight_Report.csv')" 
                                    class="bg-slate-900 dark:bg-slate-700 text-white px-8 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                Export CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[10px] font-bold">
                                <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black uppercase text-slate-400 dark:text-slate-500">
                                    <tr>
                                        <th class="p-6">Employee</th>
                                        <th class="p-6">Date</th>
                                        <th class="p-6 text-right">Amount</th>
                                        <th class="p-6">Status</th>
                                        <th class="p-6 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-700">
                                    ${(state.allLoans || []).map(ln => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors">
                                            <td class="p-6 font-black uppercase">${ln.name} (${ln.employee_id})</td>
                                            <td class="p-6 font-mono text-slate-400 dark:text-slate-500 uppercase">${formatDate(ln.applied_at)}</td>
                                            <td class="p-6 text-right font-mono font-black">Rs. ${cleanNumber(ln.amount).toLocaleString()}</td>
                                            <td class="p-6">
                                                <span class="status-badge ${ln.status === 'Approved' ? 'status-approved' : ln.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                                    ${ln.status}
                                                </span>
                                            </td>
                                            <td class="p-6 flex justify-center gap-3">
                                                <button onclick="approveLoan('${ln.id}', 'Approved')" 
                                                        class="bg-green-700 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-green-800 transition-all">
                                                    Approve
                                                </button>
                                                <button onclick="approveLoan('${ln.id}', 'Rejected')" 
                                                        class="bg-red-600 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-red-700 transition-all">
                                                    Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            } else if (state.loanTab === 'apply') {
                return `
                    <div class="bg-white dark:bg-slate-800 p-12 rounded-[3.5rem] max-w-2xl mx-auto border-2 border-slate-100 dark:border-slate-700 shadow-2xl animate-slide-up relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-green-700"></div>
                        <h3 class="font-black text-3xl mb-10 uppercase tracking-tight text-center">Loan Application</h3>
                        <form onsubmit="handleLoanApply(event)" class="space-y-8">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Requested Amount (Rs.)</label>
                                <input type="number" id="ln-amt-val-hub" 
                                       class="w-full p-5 rounded-[1.5rem] border-2 font-black bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 focus:border-green-600 outline-none text-2xl transition-all"
                                       placeholder="0.00"
                                       min="0"
                                       step="1000"
                                       required>
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Reason for Loan</label>
                                <textarea id="ln-rsn-val-hub" 
                                          class="w-full p-5 rounded-[1.5rem] border-2 font-bold h-32 bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 transition-all text-base"
                                          placeholder="Please describe the reason for this loan..."
                                          required></textarea>
                            </div>
                            <button type="submit" 
                                    class="w-full py-6 bg-green-700 text-white rounded-[1.5rem] font-black uppercase tracking-widest shadow-lg hover:bg-green-800 transition-all">
                                Submit Application
                            </button>
                        </form>
                    </div>`;
            } else {
                return `
                    <div class="space-y-6 max-w-4xl mx-auto">
                        <div class="overflow-hidden rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-700 shadow-xl">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black uppercase text-[10px] text-slate-400 dark:text-slate-500 tracking-widest">
                                    <tr>
                                        <th class="p-6">Applied Date</th>
                                        <th class="p-6">Loan Amount</th>
                                        <th class="p-6">Status</th>
                                        <th class="p-6 text-right">Remaining Balance</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-700 font-bold text-slate-800 dark:text-slate-200">
                                    ${(state.userLoans || []).map(ln => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-900">
                                            <td class="p-6 font-mono text-slate-400 dark:text-slate-500">${formatDate(ln.applied_at)}</td>
                                            <td class="p-6 font-black uppercase">Rs. ${cleanNumber(ln.amount).toLocaleString()}</td>
                                            <td class="p-6">
                                                <span class="status-badge ${ln.status === 'Approved' ? 'status-approved' : ln.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                                    ${ln.status}
                                                </span>
                                            </td>
                                            <td class="p-6 text-right font-mono text-slate-400 dark:text-slate-500">Rs. ${netOutstanding.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                    ${state.userLoans.length === 0 ? `
                                        <tr>
                                            <td colspan="4" class="p-20 text-center font-black text-slate-300 dark:text-slate-600 uppercase tracking-widest">
                                                No Loan History
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
        }

        // --- LOANS HUB - FIXED FUNCTIONS ---
async function handleLoanApply(e) {
    e.preventDefault();
    
    const amountEl = document.getElementById('ln-amt-val-hub');
    const reasonEl = document.getElementById('ln-rsn-val-hub');
    
    if (!amountEl || !reasonEl) {
        notify("Form elements not found");
        return;
    }
    
    const amount = cleanNumber(amountEl.value);
    const reason = reasonEl.value.trim();
    
    // Validation
    if (amount <= 0) {
        notify("Please enter a valid amount greater than 0");
        amountEl.focus();
        return;
    }
    
    if (reason.length < 10) {
        notify("Please provide a detailed reason (minimum 10 characters)");
        reasonEl.focus();
        return;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    try {
        const payload = {
            employeeId: state.user.id,
            employeeName: state.user.name,
            amount: amount,
            reason: reason,
            applied_at: new Date().toISOString()
        };
        
        console.log("Sending loan application:", payload);
        
        const response = await fetch(`${API_BASE}/loans`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            notify("✓ Loan application submitted successfully!");
            
            // Clear form
            amountEl.value = '';
            reasonEl.value = '';
            
            // Switch to history tab and refresh data
            state.loanTab = 'history';
            await syncData();
            renderLoans();
        } else {
            // Handle API error response
            const errorMessage = result.message || result.error || `Server error: ${response.status}`;
            console.error("Loan application failed:", errorMessage);
            notify(`✗ ${errorMessage}`);
        }
    } catch (error) {
        console.error("Network error:", error);
        notify("✗ Network error. Please check your connection and try again.");
        
        // Fallback to localStorage for offline demo
        if (confirm("You're offline. Save application locally?")) {
            saveLoanOffline(amount, reason);
        }
    } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        lucide.createIcons();
    }
}

// Offline fallback function
function saveLoanOffline(amount, reason) {
    try {
        const offlineLoans = JSON.parse(localStorage.getItem('offline_loans') || '[]');
        
        const offlineLoan = {
            id: 'offline_' + Date.now(),
            employeeId: state.user.id,
            employeeName: state.user.name,
            amount: amount,
            reason: reason,
            status: 'Pending',
            applied_at: new Date().toISOString(),
            offline: true
        };
        
        offlineLoans.push(offlineLoan);
        localStorage.setItem('offline_loans', JSON.stringify(offlineLoans));
        
        // Add to state for display
        if (!state.userLoans) state.userLoans = [];
        state.userLoans.push(offlineLoan);
        
        notify("✓ Application saved offline. Will sync when back online.");
        
        // Switch to history tab
        state.loanTab = 'history';
        renderLoans();
    } catch (error) {
        console.error("Failed to save offline:", error);
        notify("✗ Failed to save application offline.");
    }
}

// Add this function to sync offline loans when back online
async function syncOfflineLoans() {
    try {
        const offlineLoans = JSON.parse(localStorage.getItem('offline_loans') || '[]');
        
        if (offlineLoans.length === 0) return;
        
        notify(`Syncing ${offlineLoans.length} offline loan applications...`);
        
        for (const loan of offlineLoans) {
            try {
                const payload = {
                    employeeId: loan.employeeId,
                    employeeName: loan.employeeName,
                    amount: loan.amount,
                    reason: loan.reason,
                    applied_at: loan.applied_at
                };
                
                const response = await fetch(`${API_BASE}/loans`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // Remove from offline storage
                    const index = offlineLoans.indexOf(loan);
                    offlineLoans.splice(index, 1);
                }
            } catch (error) {
                console.error("Failed to sync loan:", error);
            }
        }
        
        // Update localStorage
        localStorage.setItem('offline_loans', JSON.stringify(offlineLoans));
        
        if (offlineLoans.length === 0) {
            notify("✓ All offline loans synced successfully!");
        } else {
            notify(`⚠ ${offlineLoans.length} loans still pending sync`);
        }
    } catch (error) {
        console.error("Sync offline loans error:", error);
    }
}

// Update the renderLoanContent function to show offline loans
function renderLoanContent(isAdmin, netOutstanding) {
    if (state.loanTab === 'oversight' && isAdmin) {
        return `
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border-2 border-slate-100 dark:border-slate-700 shadow-2xl overflow-hidden">
                <div class="bg-slate-50 dark:bg-slate-900 p-8 border-b dark:border-slate-700 flex justify-between items-center">
                    <span class="font-black text-xs uppercase text-slate-500 dark:text-slate-400 tracking-widest">Loan Applications</span>
                    <div class="flex gap-2">
                        <button onclick="exportToCSV(state.allLoans, 'Loans_Oversight_Report.csv')" 
                                class="bg-slate-900 dark:bg-slate-700 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            Export CSV
                        </button>
                        <button onclick="syncOfflineLoans()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">
                            Sync Offline
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[10px] font-bold">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black uppercase text-slate-400 dark:text-slate-500">
                            <tr>
                                <th class="p-6">Employee</th>
                                <th class="p-6">Date</th>
                                <th class="p-6 text-right">Amount</th>
                                <th class="p-6">Status</th>
                                <th class="p-6">Source</th>
                                <th class="p-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y dark:divide-slate-700">
                            ${(state.allLoans || []).map(ln => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors">
                                    <td class="p-6 font-black uppercase">${ln.name || ln.employeeName} (${ln.employee_id || ln.employeeId})</td>
                                    <td class="p-6 font-mono text-slate-400 dark:text-slate-500 uppercase">${formatDate(ln.applied_at)}</td>
                                    <td class="p-6 text-right font-mono font-black">Rs. ${cleanNumber(ln.amount).toLocaleString()}</td>
                                    <td class="p-6">
                                        <span class="status-badge ${ln.status === 'Approved' ? 'status-approved' : ln.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                            ${ln.status || 'Pending'}
                                        </span>
                                    </td>
                                    <td class="p-6">
                                        ${ln.offline ? 
                                            '<span class="text-orange-500 text-xs font-bold">OFFLINE</span>' : 
                                            '<span class="text-green-500 text-xs font-bold">ONLINE</span>'}
                                    </td>
                                    <td class="p-6 flex justify-center gap-3">
                                        ${!ln.offline ? `
                                            <button onclick="approveLoan('${ln.id}', 'Approved')" 
                                                    class="bg-green-700 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-green-800 transition-all">
                                                Approve
                                            </button>
                                            <button onclick="approveLoan('${ln.id}', 'Rejected')" 
                                                    class="bg-red-600 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-red-700 transition-all">
                                                Reject
                                            </button>
                                        ` : `
                                            <span class="text-slate-400 text-xs">Sync required</span>
                                        `}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
    } else if (state.loanTab === 'apply') {
        return `
            <div class="bg-white dark:bg-slate-800 p-12 rounded-[3.5rem] max-w-2xl mx-auto border-2 border-slate-100 dark:border-slate-700 shadow-2xl animate-slide-up relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-green-700"></div>
                <h3 class="font-black text-3xl mb-10 uppercase tracking-tight text-center">Loan Application</h3>
                
                <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center gap-2 text-blue-700 dark:text-blue-400">
                        <i data-lucide="info" size="18"></i>
                        <p class="text-sm font-bold">Loan Eligibility</p>
                    </div>
                    <p class="text-xs text-blue-600 dark:text-blue-300 mt-1">
                        Max loan amount: Rs. ${Math.floor(cleanNumber(state.user.basic_salary) * 3).toLocaleString()}
                    </p>
                </div>
                
                <form id="loan-application-form" onsubmit="handleLoanApply(event)" class="space-y-8">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">
                            Requested Amount (Rs.)
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ln-amt-val-hub" 
                               class="w-full p-5 rounded-[1.5rem] border-2 font-black bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 focus:border-green-600 outline-none text-2xl transition-all"
                               placeholder="0.00"
                               min="1000"
                               max="${Math.floor(cleanNumber(state.user.basic_salary) * 3)}"
                               step="1000"
                               required>
                        <p class="text-xs text-slate-400 dark:text-slate-500 mt-2">
                            Minimum: Rs. 1,000 | Maximum: 3x Basic Salary
                        </p>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">
                            Reason for Loan
                            <span class="text-red-500">*</span>
                        </label>
                        <textarea id="ln-rsn-val-hub" 
                                  class="w-full p-5 rounded-[1.5rem] border-2 font-bold h-32 bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 transition-all text-base"
                                  placeholder="Please describe the reason for this loan in detail..."
                                  minlength="10"
                                  maxlength="500"
                                  required></textarea>
                        <div class="flex justify-between text-xs text-slate-400 dark:text-slate-500 mt-2">
                            <span>Minimum 10 characters</span>
                            <span id="char-count">0/500</span>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="calculator" size="18" class="text-green-600"></i>
                            <p class="font-bold text-sm">Estimated Monthly Deduction</p>
                        </div>
                        <p class="text-2xl font-black text-green-700 dark:text-green-400" id="estimated-deduction">
                            Rs. 0
                        </p>
                        <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">
                            Based on 12-month repayment plan
                        </p>
                    </div>
                    <button type="submit" 
                            class="w-full py-6 bg-green-700 text-white rounded-[1.5rem] font-black uppercase tracking-widest shadow-lg hover:bg-green-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            id="loan-submit-btn">
                        Submit Application
                    </button>
                </form>
            </div>`;
    } else {
        // Combine online and offline loans for history
        const allUserLoans = [...(state.userLoans || [])];
        
        // Add offline loans if any
        try {
            const offlineLoans = JSON.parse(localStorage.getItem('offline_loans') || '[]')
                .filter(loan => loan.employeeId === state.user.id);
            allUserLoans.push(...offlineLoans);
        } catch (e) {
            console.error("Error loading offline loans:", e);
        }
        
        // Sort by date
        allUserLoans.sort((a, b) => new Date(b.applied_at) - new Date(a.applied_at));
        
        return `
            <div class="space-y-6 max-w-4xl mx-auto">
                <div class="overflow-hidden rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-700 shadow-xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black uppercase text-[10px] text-slate-400 dark:text-slate-500 tracking-widest">
                            <tr>
                                <th class="p-6">Applied Date</th>
                                <th class="p-6">Loan Amount</th>
                                <th class="p-6">Status</th>
                                <th class="p-6">Source</th>
                                <th class="p-6 text-right">Remaining Balance</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y dark:divide-slate-700 font-bold text-slate-800 dark:text-slate-200">
                            ${allUserLoans.map(ln => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-900">
                                    <td class="p-6 font-mono text-slate-400 dark:text-slate-500">${formatDate(ln.applied_at)}</td>
                                    <td class="p-6 font-black uppercase">Rs. ${cleanNumber(ln.amount).toLocaleString()}</td>
                                    <td class="p-6">
                                        <span class="status-badge ${ln.status === 'Approved' ? 'status-approved' : ln.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                            ${ln.status || 'Pending'}
                                            ${ln.offline ? ' (Offline)' : ''}
                                        </span>
                                    </td>
                                    <td class="p-6">
                                        ${ln.offline ? 
                                            '<span class="text-orange-500 text-xs font-bold">OFFLINE</span>' : 
                                            '<span class="text-green-500 text-xs font-bold">ONLINE</span>'}
                                    </td>
                                    <td class="p-6 text-right font-mono text-slate-400 dark:text-slate-500">
                                        Rs. ${netOutstanding.toLocaleString()}
                                    </td>
                                </tr>
                            `).join('')}
                            ${allUserLoans.length === 0 ? `
                                <tr>
                                    <td colspan="5" class="p-20 text-center font-black text-slate-300 dark:text-slate-600 uppercase tracking-widest">
                                        No Loan History
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
                
                <!-- Offline loans notice -->
                ${(() => {
                    try {
                        const offlineLoans = JSON.parse(localStorage.getItem('offline_loans') || '[]')
                            .filter(loan => loan.employeeId === state.user.id && loan.status === 'Pending');
                        
                        if (offlineLoans.length > 0) {
                            return `
                                <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-2xl p-6">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="wifi-off" class="text-orange-600 dark:text-orange-400" size="24"></i>
                                        <div>
                                            <p class="font-bold text-orange-800 dark:text-orange-300">
                                                ${offlineLoans.length} offline application${offlineLoans.length > 1 ? 's' : ''} pending sync
                                            </p>
                                            <p class="text-sm text-orange-600 dark:text-orange-400 mt-1">
                                                Applications will be sent when you're back online
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    } catch (e) {
                        return '';
                    }
                })()}
            </div>`;
    }
}

// Add character counter for loan reason
document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'ln-rsn-val-hub') {
        const charCount = e.target.value.length;
        const counter = document.getElementById('char-count');
        if (counter) {
            counter.textContent = `${charCount}/500`;
            if (charCount > 500) {
                counter.classList.add('text-red-500');
            } else if (charCount > 400) {
                counter.classList.add('text-orange-500');
            } else {
                counter.classList.remove('text-red-500', 'text-orange-500');
            }
        }
    }
    
    // Calculate estimated deduction
    if (e.target && e.target.id === 'ln-amt-val-hub') {
        const amount = cleanNumber(e.target.value);
        const estimated = document.getElementById('estimated-deduction');
        if (estimated && amount > 0) {
            const monthlyDeduction = Math.ceil(amount / 12);
            estimated.textContent = `Rs. ${monthlyDeduction.toLocaleString()}`;
        }
    }
});

// Also update the approveLoan function
async function approveLoan(id, status) {
    if (!confirm(`Are you sure you want to ${status.toLowerCase()} this loan?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/admin/loans/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            notify(`✓ Loan ${status.toLowerCase()} successfully`);
            await syncData();
            renderLoans();
        } else {
            const errorMessage = result.message || result.error || `Server error: ${response.status}`;
            notify(`✗ Failed: ${errorMessage}`);
        }
    } catch (error) {
        console.error("Approve loan error:", error);
        notify("✗ Network error. Please try again.");
    }
}

// Update syncData function to include offline loans in userLoans
async function syncData() {
    if (!state.user) return;
    
    try {
        // ... existing sync code ...
        
        // Load offline loans for current user
        try {
            const offlineLoans = JSON.parse(localStorage.getItem('offline_loans') || '[]')
                .filter(loan => loan.employeeId === state.user.id);
            
            if (state.userLoans) {
                state.userLoans = [...state.userLoans, ...offlineLoans];
            } else {
                state.userLoans = offlineLoans;
            }
        } catch (e) {
            console.error("Error loading offline loans:", e);
        }
        
        // ... rest of sync code ...
    } catch (e) {
        console.warn("Sync Error", e);
        notify("⚠ Sync failed. Using cached data.");
    }
}

        // --- LEAVES HUB ---
        async function renderLeaves() {
            const container = document.getElementById('view-container');
            const isAdmin = state.user && state.user.role === 'admin';
            const targetUser = state.employees.find(e => e.id === state.user.id) || state.user;
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                        <div class="bg-green-700 text-white shadow-2xl p-10 rounded-[3rem] relative overflow-hidden">
                            <p class="text-[10px] font-black uppercase opacity-60">Annual Leave Balance</p>
                            <p class="text-6xl font-black mt-4 font-mono">${targetUser.leave_annual || 0} <span class="text-lg opacity-40 uppercase">Days</span></p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 border-2 border-slate-50 dark:border-slate-700 shadow-sm p-10 rounded-[3rem]">
                            <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase">Casual Leave Balance</p>
                            <p class="text-6xl font-black mt-4 font-mono text-slate-800 dark:text-slate-200">${targetUser.leave_casual || 0} <span class="text-lg text-slate-200 dark:text-slate-600 uppercase">Days</span></p>
                        </div>
                    </div>
                    
                    <div class="flex bg-slate-200 dark:bg-slate-700 p-2 rounded-[2rem] max-w-sm mx-auto mb-10 shadow-inner">
                        <button onclick="state.leaveTab='apply'; renderLeaves()" 
                                class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase tracking-widest transition-all ${state.leaveTab === 'apply' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                            Apply Leave
                        </button>
                        <button onclick="state.leaveTab='history'; renderLeaves()" 
                                class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase tracking-widest transition-all ${state.leaveTab === 'history' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                            My History
                        </button>
                        ${isAdmin ? `
                            <button onclick="state.leaveTab='oversight'; renderLeaves()" 
                                    class="flex-1 py-3 text-[10px] font-black rounded-2xl uppercase transition-all ${state.leaveTab === 'oversight' ? 'bg-white dark:bg-slate-800 text-green-700 dark:text-green-400 shadow-xl' : 'text-slate-500 dark:text-slate-400'}">
                                Oversight
                            </button>
                        ` : ''}
                    </div>
                    
                    ${renderLeaveContent(isAdmin)}
                </div>`;
            
            lucide.createIcons();
        }

        function renderLeaveContent(isAdmin) {
            if (state.leaveTab === 'oversight' && isAdmin) {
                return `
                    <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] border-2 border-slate-50 dark:border-slate-700 shadow-2xl overflow-hidden">
                        <div class="bg-slate-50 dark:bg-slate-900 p-8 border-b dark:border-slate-700 flex justify-between items-center">
                            <span class="font-black text-xs uppercase text-slate-600 dark:text-slate-400 tracking-widest">Leave Applications</span>
                            <button onclick="exportToCSV(state.allLeaves, 'Leaves_Report.csv')" 
                                    class="bg-slate-900 dark:bg-slate-700 text-white px-8 py-2.5 rounded-xl font-black text-[10px] uppercase shadow-lg">
                                Export CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[11px] font-bold">
                                <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black uppercase text-slate-400 dark:text-slate-500">
                                    <tr>
                                        <th class="p-6">Employee</th>
                                        <th class="p-6">Leave Type</th>
                                        <th class="p-6">Start Date</th>
                                        <th class="p-6 text-center">Days</th>
                                        <th class="p-6">Status</th>
                                        <th class="p-6 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-700">
                                    ${(state.allLeaves || []).map(lv => {
                                        const emp = state.employees.find(e => e.id === lv.employee_id) || {};
                                        return `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors">
                                                <td class="p-6 font-black uppercase">${lv.name} (${lv.employee_id})</td>
                                                <td class="p-6 uppercase text-slate-500 dark:text-slate-400">${lv.leave_type}</td>
                                                <td class="p-6 font-mono">${formatDate(lv.start_date)}</td>
                                                <td class="p-6 text-center font-black">${lv.days}</td>
                                                <td class="p-6">
                                                    <span class="status-badge ${lv.status === 'Approved' ? 'status-approved' : lv.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                                        ${lv.status}
                                                    </span>
                                                </td>
                                                <td class="p-6 flex justify-center gap-3">
                                                    <button onclick="approveLeave('${lv.id}', 'Approved')" 
                                                            class="bg-green-700 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-green-800 transition-all">
                                                        Approve
                                                    </button>
                                                    <button onclick="approveLeave('${lv.id}', 'Rejected')" 
                                                            class="bg-red-600 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg hover:bg-red-700 transition-all">
                                                        Reject
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            } else if (state.leaveTab === 'apply') {
                const today = new Date().toISOString().split('T')[0];
                return `
                    <div class="bg-white dark:bg-slate-800 p-12 rounded-[3.5rem] max-w-2xl mx-auto border-2 border-slate-100 dark:border-slate-700 shadow-2xl animate-slide-up relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-green-700"></div>
                        <h3 class="font-black text-3xl mb-10 uppercase tracking-tight text-center">Leave Application</h3>
                        <form onsubmit="handleLeaveApply(event)" class="space-y-6">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Leave Type</label>
                                <select id="lv-type-input-hub" 
                                        class="w-full p-5 rounded-[1.5rem] border-2 font-black bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 focus:border-green-600 outline-none transition-all">
                                    <option value="Annual Leave">Annual Leave</option>
                                    <option value="Casual Leave">Casual Leave</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="Emergency Leave">Emergency Leave</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Start Date</label>
                                    <input type="date" id="lv-date-input-hub" 
                                           class="w-full p-5 rounded-[1.5rem] border-2 font-black bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                           min="${today}"
                                           required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Number of Days</label>
                                    <input type="number" id="lv-days-input-hub" 
                                           class="w-full p-5 rounded-[1.5rem] border-2 font-black bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 outline-none"
                                           min="1"
                                           max="30"
                                           required>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 dark:text-slate-500 ml-2 mb-2 block">Reason</label>
                                <textarea id="lv-rsn-input-hub" 
                                          class="w-full p-5 rounded-[1.5rem] border-2 font-bold h-24 bg-slate-50 dark:bg-slate-900 dark:text-white focus:bg-white dark:focus:bg-slate-800 transition-all"
                                          placeholder="Please provide a reason for your leave..."
                                          required></textarea>
                            </div>
                            <button type="submit" 
                                    class="w-full py-6 bg-green-700 text-white rounded-[1.5rem] font-black uppercase tracking-widest shadow-xl hover:bg-green-800 transition-all">
                                Submit Application
                            </button>
                        </form>
                    </div>`;
            } else {
                return `
                    <div class="space-y-6 max-w-3xl mx-auto">
                        ${(state.userLeaves || []).map(lv => `
                            <div class="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] border-2 border-slate-50 dark:border-slate-700 shadow-sm flex justify-between items-center hover:border-green-200 dark:hover:border-green-600 transition-all">
                                <div class="flex items-center gap-6">
                                    <div class="bg-slate-50 dark:bg-slate-900 p-5 rounded-2xl text-slate-400 dark:text-slate-600">
                                        <i data-lucide="calendar"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-black uppercase text-slate-800 dark:text-slate-200 text-lg leading-tight">${lv.leave_type}</h4>
                                        <p class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase mt-2 tracking-widest">
                                            ${formatDate(lv.start_date)} • ${lv.days} Days
                                        </p>
                                        ${lv.reason ? `<p class="text-sm text-slate-600 dark:text-slate-400 mt-2">${lv.reason}</p>` : ''}
                                    </div>
                                </div>
                                <span class="status-badge ${lv.status === 'Approved' ? 'status-approved' : lv.status === 'Rejected' ? 'status-rejected' : 'status-pending'}">
                                    ${lv.status}
                                </span>
                            </div>
                        `).join('')}
                        ${state.userLeaves.length === 0 ? `
                            <div class="text-center py-20">
                                <p class="text-slate-300 dark:text-slate-600 font-black uppercase tracking-widest">No Leave History</p>
                            </div>
                        ` : ''}
                    </div>`;
            }
        }

        async function handleLeaveApply(e) {
            e.preventDefault();
            
            const type = document.getElementById('lv-type-input-hub').value;
            const startDate = document.getElementById('lv-date-input-hub').value;
            const days = parseInt(document.getElementById('lv-days-input-hub').value);
            const reason = document.getElementById('lv-rsn-input-hub').value.trim();
            
            if (days <= 0 || days > 30) {
                notify("Please enter a valid number of days (1-30)");
                return;
            }
            
            if (reason.length < 10) {
                notify("Please provide a detailed reason (minimum 10 characters)");
                return;
            }
            
            const payload = {
                employeeId: state.user.id,
                type: type,
                startDate: startDate,
                days: days,
                reason: reason
            };
            
            try {
                const res = await fetch(`${API_BASE}/leaves`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    notify("Leave application submitted successfully");
                    document.getElementById('lv-rsn-input-hub').value = '';
                    state.leaveTab = 'history';
                    await syncData();
                    renderLeaves();
                } else {
                    notify("Failed to submit leave application");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        async function approveLeave(id, status) {
            try {
                const res = await fetch(`${API_BASE}/admin/leaves/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ status })
                });
                
                if (res.ok) {
                    notify(`Leave ${status.toLowerCase()} successfully`);
                    await syncData();
                    renderLeaves();
                } else {
                    notify("Failed to update leave status");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        // --- DISCUSSION BOARD ---
        function renderDiscussion() {
            const container = document.getElementById('view-container');
            
            container.innerHTML = `
                <div class="animate-fade-in space-y-10 max-w-5xl mx-auto">
                    <div class="border-b-2 pb-6 border-slate-100 dark:border-slate-700">
                        <h2 class="text-4xl font-black uppercase tracking-tighter text-slate-800 dark:text-slate-200">Discussion Board</h2>
                    </div>
                    
                    <div class="bg-slate-900 dark:bg-slate-800 p-10 rounded-[3rem] shadow-2xl relative">
                        <div class="absolute top-6 right-10 flex items-center gap-2">
                            <div class="h-3 w-3 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-[9px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest">Live Broadcast Feed</span>
                        </div>
                        <form onsubmit="broadcastMessage(event)" class="flex gap-6 mt-8">
                            <input type="text" id="board-msg-hub-el" 
                                   placeholder="Type your message here..."
                                   class="flex-1 bg-white/5 border-2 border-white/10 dark:border-slate-600 rounded-2xl p-6 font-bold text-white dark:text-slate-200 text-lg outline-none focus:bg-white/10 dark:focus:bg-slate-700 focus:border-green-600 transition-all"
                                   required
                                   aria-label="Message input">
                            <button type="submit" 
                                    class="bg-green-600 hover:bg-green-500 p-6 rounded-2xl transition-all shadow-lg text-white"
                                    aria-label="Send message">
                                <i data-lucide="send" size="32"></i>
                            </button>
                        </form>
                    </div>
                    
                    <div class="space-y-8">
                        ${state.discussions.map(d => `
                            <div class="bg-white dark:bg-slate-800 p-10 rounded-[3rem] border-2 border-slate-50 dark:border-slate-700 shadow-sm hover:border-green-100 dark:hover:border-green-800 transition-all group">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="h-12 w-12 rounded-xl bg-slate-50 dark:bg-slate-900 flex items-center justify-center font-black text-slate-400 dark:text-slate-600 group-hover:bg-green-50 dark:group-hover:bg-green-900 group-hover:text-green-600 dark:group-hover:text-green-400 transition-all">
                                            ${getInitial(d.author_name)}
                                        </div>
                                        <div>
                                            <span class="font-black text-slate-800 dark:text-slate-200 uppercase text-sm">${d.author_name}</span>
                                            <p class="text-xs text-slate-400 dark:text-slate-500">${d.employee_id}</p>
                                        </div>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">${formatDate(d.created_at)}</span>
                                </div>
                                <p class="text-slate-600 dark:text-slate-300 font-bold leading-relaxed text-lg">${d.message}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            lucide.createIcons();
        }

        async function broadcastMessage(e) {
            e.preventDefault();
            
            const input = document.getElementById('board-msg-hub-el');
            const message = input.value.trim();
            
            if (message.length === 0) {
                notify("Please enter a message");
                return;
            }
            
            if (message.length > 500) {
                notify("Message too long (max 500 characters)");
                return;
            }
            
            const payload = {
                employee_id: state.user.id,
                author_name: state.user.name,
                message: message
            };
            
            try {
                const res = await fetch(`${API_BASE}/discussions`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    input.value = '';
                    await syncData();
                    renderDiscussion();
                    notify("Message posted successfully");
                } else {
                    notify("Failed to post message");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        // --- NOTIFICATIONS ---
        async function checkNotifications() {
            if (!state.user) return;
            
            try {
                // Simulate notifications for demo
                // In real app, fetch from API
                state.notifications = [
                    {
                        id: 1,
                        title: "Payroll Processed",
                        message: "Salary for March 2024 has been processed",
                        read: false,
                        timestamp: new Date().toISOString()
                    },
                    {
                        id: 2,
                        title: "Leave Approved",
                        message: "Your leave request has been approved",
                        read: false,
                        timestamp: new Date().toISOString()
                    }
                ];
                
                updateNotificationBadge();
            } catch (error) {
                console.error("Failed to fetch notifications:", error);
            }
        }

        function updateNotificationBadge() {
            const unreadCount = state.notifications.filter(n => !n.read).length;
            let badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                if (!badge) {
                    const userArea = document.getElementById('user-area');
                    const bellBtn = document.createElement('button');
                    bellBtn.className = 'relative p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all';
                    bellBtn.onclick = () => showNotifications();
                    bellBtn.innerHTML = `
                        <i data-lucide="bell"></i>
                        <span id="notification-badge" class="notification-badge">${unreadCount}</span>
                    `;
                    userArea.insertBefore(bellBtn, userArea.firstChild);
                    lucide.createIcons();
                } else {
                    badge.textContent = unreadCount;
                }
            } else if (badge) {
                badge.remove();
            }
        }

        function showNotifications() {
            const modal = document.getElementById('notification-modal');
            const list = document.getElementById('notification-list');
            
            list.innerHTML = state.notifications.map(n => `
                <div class="p-4 border-b dark:border-slate-700 last:border-0 ${n.read ? 'opacity-60' : ''}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${n.title}</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${n.message}</p>
                        </div>
                        <span class="text-xs text-slate-400">${new Date(n.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            `).join('');
            
            // Mark as read
            state.notifications.forEach(n => n.read = true);
            updateNotificationBadge();
            
            modal.classList.remove('hidden');
        }

        // --- BACKUP & RESTORE ---
        async function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                user: state.user,
                employees: state.employees,
                attendance: state.attendance,
                leaves: state.userLeaves,
                loans: state.userLoans,
                discussions: state.discussions,
                payrollPostedMonths: state.payrollPostedMonths
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(dataBlob);
            a.download = `hr_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            notify("Backup downloaded successfully");
        }

        async function restoreData(file) {
            if (!file) return;
            
            if (!confirm("Restoring backup will replace current data. Continue?")) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backup.timestamp || !backup.user) {
                        throw new Error("Invalid backup file");
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('hr_backup', e.target.result);
                    localStorage.setItem('hr_user', JSON.stringify(backup.user));
                    
                    notify("Backup restored successfully. Refreshing...");
                    setTimeout(() => location.reload(), 2000);
                    
                } catch (error) {
                    notify("Invalid backup file format");
                }
            };
            reader.readAsText(file);
        }

        // --- EXPORT FUNCTIONS ---
        function exportToCSV(data, filename) {
            if (!data || !data.length) {
                notify("No data to export");
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                    }).join(',')
                )
            ];
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            
            notify("CSV exported successfully");
        }

        function exportToPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            if (!element) {
                notify("Element not found for PDF export");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: state.darkMode ? '#0f172a' : '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                doc.save(filename);
                
                notify("PDF exported successfully");
            }).catch(error => {
                console.error("PDF export error:", error);
                notify("Failed to export PDF");
            });
        }

        // --- LOGIN HANDLER ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('login-id').value.toUpperCase();
            const password = document.getElementById('login-pass').value;
            
            if (!id || !password) {
                notify("Please enter both ID and password");
                return;
            }
            
            // Show loading
            document.getElementById('loading-screen').classList.remove('hidden');
            
            try {
                // Hash password before sending
                const hashedPassword = await hashPassword(password);
                
                // In a real app, you would send to your API
                // For demo, we'll check against stored employees
                const res = await fetch(`${API_BASE}/employees`);
                const employees = await res.json();
                
                const found = employees.find(emp => 
                    String(emp.id).toUpperCase() === id && 
                    String(emp.password) === password // In real app, compare hashed passwords
                );
                
                if (found) {
                    state.user = found;
                    localStorage.setItem('hr_user', JSON.stringify(found));
                    await syncData();
                    showApp();
                } else {
                    document.getElementById('loading-screen').classList.add('hidden');
                    notify("Invalid credentials. Please try again.");
                }
            } catch (error) {
                document.getElementById('loading-screen').classList.add('hidden');
                notify("Login failed. Please check your connection.");
            }
        });

        // --- UTILITY FUNCTIONS ---
        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('hr_user');
                location.reload();
            }
        }

        function updateMonth(v) {
            state.selectedMonth = v;
            renderPayroll();
        }

        function updateAttendanceMonth(v) {
            state.selectedAttendanceMonth = v;
            renderAttendance();
        }

        async function togglePublish(posted) {
            const method = posted ? 'DELETE' : 'POST';
            const url = posted 
                ? `${API_BASE}/payroll-post/${state.selectedMonth}`
                : `${API_BASE}/payroll-post`;
            
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type':'application/json'},
                    body: posted ? null : JSON.stringify({ month: state.selectedMonth })
                });
                
                if (res.ok) {
                    await syncData();
                    renderPayroll();
                    notify(posted ? "Payroll unpublished" : "Payroll published");
                } else {
                    notify("Failed to update payroll status");
                }
            } catch (error) {
                notify("Network error. Please try again.");
            }
        }

        function exportAttendanceCSV(isAdmin) {
            const data = state.attendance.map(l => ({
                "ID": l.employee_id,
                "Name": state.employees.find(e => e.id === l.employee_id)?.name || 'Unknown',
                "Date": l.date_str,
                "Time": l.time_str,
                "Action": l.type,
                "Latitude": l.latitude,
                "Longitude": l.longitude,
                "Work Hours": calculateWorkTime(
                    l.type === 'Clock In' ? l.time_str : null,
                    l.type === 'Clock Out' ? l.time_str : null
                )
            }));
            
            exportToCSV(data, `Attendance_Report_${state.selectedAttendanceMonth}.csv`);
        }

        // --- SERVICE WORKER FOR OFFLINE SUPPORT ---
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', event => {
                    console.log('Service Worker installing...');
                    self.skipWaiting();
                });

                self.addEventListener('activate', event => {
                    console.log('Service Worker activating...');
                });

                self.addEventListener('fetch', event => {
                    // You can add caching strategies here
                });
            `;
            
            // Create a temporary service worker file
            const blob = new Blob([swCode], {type: 'application/javascript'});
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('SW registered:', registration))
                .catch(error => console.log('SW registration failed:', error));
        }
    </script>
</body>
</html>
