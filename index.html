import React, { useState, useEffect, useRef } from 'react';
import { 
  MapPin, Clock, Calendar, User, Home, LogOut, CheckCircle2, 
  AlertCircle, ChevronRight, Briefcase, Menu, X, DollarSign, 
  Heart, Users, Search, FileText, Download, Shield, Activity,
  Upload, FileSpreadsheet, Table, Eye, Wallet, ArrowLeft, Pencil, Trash2, Lock, Key, ShieldAlert, Save, Mail, MessageSquare, Send, Reply, Bell
} from 'lucide-react';

// --- Global Configuration ---
const API_BASE = '/api'; 
const COMPANY_NAME = "Lahore School of Accountancy and Finance";
const LOGO_URL = "/cropped-UOL-Green-V1.png";

/**
 * CORE DIAGNOSTIC SYSTEM
 */
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, info) { console.error("CRITICAL SYSTEM FAILURE:", error, info); }
  render() {
    if (this.state.hasError) {
      return (
        <div style={{ padding: '50px', backgroundColor: '#fff1f2', minHeight: '100vh', fontFamily: 'monospace' }}>
          <div style={{ maxWidth: '800px', margin: '0 auto', backgroundColor: 'white', padding: '30px', borderRadius: '20px', border: '2px solid #fecaca', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.1)' }}>
            <h1 style={{ color: '#be123c', fontSize: '24px', fontWeight: '900', marginBottom: '20px' }}>SYSTEM EXECUTION HALTED</h1>
            <p style={{ color: '#475569', marginBottom: '10px' }}>The NexusHR Frontend crashed. Diagnostic Data:</p>
            <div style={{ backgroundColor: '#1e293b', color: '#4ade80', padding: '20px', borderRadius: '10px', fontSize: '12px', overflow: 'auto' }}>
              <p><strong>Error:</strong> {this.state.error?.toString()}</p>
              <pre style={{ marginTop: '10px' }}>{this.state.error?.stack}</pre>
            </div>
            <button onClick={() => { localStorage.clear(); window.location.reload(); }} style={{ marginTop: '20px', backgroundColor: '#be123c', color: 'white', padding: '12px 24px', borderRadius: '10px', border: 'none', cursor: 'pointer', fontWeight: 'bold' }}>
              REBOOT SYSTEM & CLEAR CACHE
            </button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

/**
 * UTILITY HELPERS
 */
function parseCSVLine(text) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"') inQuotes = !inQuotes;
    else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else current += char;
  }
  result.push(current.trim());
  return result;
}

function cleanNumber(val) {
  if (val === undefined || val === null || val === '-' || val === '') return 0;
  const num = parseFloat(String(val).replace(/[^0-9.-]+/g, ''));
  return isNaN(num) ? 0 : num;
}

function getInitial(name) {
  if (!name) return '?';
  return String(name).charAt(0).toUpperCase();
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString();
}

function exportToCSV(data, filename) {
  if (!data || !data.length) { alert("Data Stream Error: Nothing to export."); return; }
  const headers = Object.keys(data[0]).join(',');
  const rows = data.map(row => Object.values(row).map(val => '"' + String(val).replace(/"/g, '""') + '"').join(','));
  const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join('\n');
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function getPktTime() { return new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Karachi', hour: '2-digit', minute: '2-digit', hour12: true }); }
function getPktDate() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Karachi' }); }

/**
 * BASE UI PRIMITIVES
 */
function Button({ children, onClick, variant = 'primary', className = '', disabled = false, icon: Icon, component = 'button', ...props }) {
  const baseStyle = "flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 disabled:pointer-events-none cursor-pointer whitespace-nowrap text-sm";
  const variants = {
    primary: "bg-green-700 text-white shadow-md hover:bg-green-800",
    secondary: "bg-white text-slate-700 border border-slate-200 shadow-sm hover:bg-slate-50",
    danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100",
    ghost: "bg-transparent text-slate-500 hover:bg-slate-100"
  };
  const combinedClass = baseStyle + " " + (variants[variant] || variants.primary) + " " + className;
  if (component === 'label') return <label className={combinedClass} {...props}>{Icon && <Icon size={18} />}{children}</label>;
  return <button onClick={onClick} disabled={disabled} className={combinedClass} {...props}>{Icon && <Icon size={18} />}{children}</button>;
}

function Card({ children, className = '' }) {
  return <div className={"bg-white rounded-2xl p-6 shadow-sm border border-slate-100 " + className}>{children}</div>;
}

function Badge({ status }) {
  const styles = { Approved: 'bg-green-100 text-green-700', Active: 'bg-green-100 text-green-700', Pending: 'bg-amber-100 text-amber-700', Rejected: 'bg-red-100 text-red-700', Present: 'bg-blue-100 text-blue-700' };
  return <span className={"text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider " + (styles[status] || 'bg-slate-100 text-slate-600')}>{String(status || 'None')}</span>;
}

/**
 * VIEWS
 */

function LoginView({ onLogin, loading }) {
  const [id, setId] = useState('');
  const [password, setPassword] = useState('');
  const submit = (e) => { e.preventDefault(); onLogin(id, password); };
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4 font-sans">
      <Card className="w-full max-w-md space-y-6 !p-10 shadow-2xl border-none animate-slide-up">
        <div className="text-center">
          <img src={LOGO_URL} alt="Logo" className="h-16 mx-auto mb-4 object-contain" />
          <h1 className="text-xl font-black text-slate-800 uppercase tracking-tighter">{COMPANY_NAME}</h1>
          <p className="text-slate-500 text-xs mt-2 font-bold uppercase tracking-widest">Administrative Hub v4.4.5</p>
        </div>
        <form onSubmit={submit} className="space-y-4">
          <div className="space-y-1">
            <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Employee ID</label>
            <input type="text" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 outline-none focus:bg-white focus:ring-2 focus:ring-green-500 font-bold uppercase" placeholder="EMP001" value={id} onChange={(e) => setId(e.target.value)} required />
          </div>
          <div className="space-y-1">
            <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Password</label>
            <input type="password" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 outline-none focus:bg-white focus:ring-2 focus:ring-green-500 font-bold" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
          </div>
          <Button className="w-full py-4 bg-green-700 font-black uppercase tracking-widest mt-2" disabled={loading}>{loading ? 'Establishing Link...' : 'Initiate Session'}</Button>
        </form>
      </Card>
    </div>
  );
}

function DashboardView({ user, history }) {
  if (!user) return null;
  return (
    <div className="space-y-6 animate-fade-in text-slate-900">
      <div className="flex items-center justify-between border-b pb-4 border-slate-100">
        <h1 className="text-2xl font-black uppercase tracking-tight">Dashboard</h1>
        <div className="bg-white p-3 rounded-2xl border shadow-sm text-right font-black">
           <p className="text-[10px] text-slate-400 uppercase">Pakistan Standard Time (PKT)</p>
           <p className="text-green-700">{getPktTime()}</p>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="bg-green-700 text-white !p-8 shadow-xl relative overflow-hidden group">
           <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform"></div>
           <p className="text-[10px] font-black uppercase opacity-60">Status</p>
           <p className="text-3xl font-black mt-2 tracking-tighter">ACTIVE SESSION</p>
        </Card>
        <Card className="!p-8 border shadow-sm">
           <p className="text-[10px] font-black text-slate-400 uppercase">Annual Leaves</p>
           <p className="text-3xl font-black text-slate-800 mt-2">{user.leave_annual || 0} Days</p>
        </Card>
        <Card className="!p-8 border shadow-sm">
           <p className="text-[10px] font-black text-slate-400 uppercase">System Identity</p>
           <p className="text-2xl font-black text-slate-800 mt-2 capitalize">{user.role}</p>
        </Card>
      </div>
    </div>
  );
}

function DirectoryView({ employees, onAddMember, onEditMember, onDeleteMember }) {
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [form, setForm] = useState({ id: '', name: '', email: '', role: 'employee', leave_annual: 14, leave_casual: 10 });

  const submit = async (e) => {
    e.preventDefault();
    if (editingId) { await onEditMember(form); }
    else { await onAddMember(form); }
    setIsFormOpen(false);
    setEditingId(null);
    setForm({ id: '', name: '', email: '', role: 'employee', leave_annual: 14, leave_casual: 10 });
  };

  const handleEdit = (emp) => {
    setEditingId(emp.id);
    setForm(emp);
    setIsFormOpen(true);
  };

  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="flex justify-between items-center border-b pb-4 border-slate-100">
        <h2 className="text-xl font-black uppercase tracking-tighter">Staff Hub</h2>
        <Button onClick={() => setIsFormOpen(true)} icon={User}>New Member</Button>
      </div>

      {isFormOpen && (
        <Card className="border-2 border-green-100 animate-slide-up">
          <form onSubmit={submit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Staff ID</label>
              <input type="text" disabled={!!editingId} className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold outline-none focus:bg-white" value={form.id} onChange={e => setForm({...form, id: e.target.value})} required />
            </div>
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Legal Name</label>
              <input type="text" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold outline-none focus:bg-white" value={form.name} onChange={e => setForm({...form, name: e.target.value})} required />
            </div>
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Email Address</label>
              <input type="email" className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold outline-none focus:bg-white" value={form.email} onChange={e => setForm({...form, email: e.target.value})} required />
            </div>
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Access Role</label>
              <select className="w-full p-4 rounded-xl border-2 border-slate-50 bg-slate-50 font-bold outline-none focus:bg-white" value={form.role} onChange={e => setForm({...form, role: e.target.value})}>
                <option value="employee">Staff Member</option>
                <option value="admin">System Admin</option>
              </select>
            </div>
            <div className="flex justify-end gap-3 md:col-span-2 pt-4 border-t border-slate-50">
               <Button variant="ghost" onClick={() => setIsFormOpen(false)}>Cancel</Button>
               <Button type="submit">Synchronize Identity</Button>
            </div>
          </form>
        </Card>
      )}

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {employees.map(emp => (
          <Card key={emp.id} className="flex items-center gap-4 group hover:border-green-300 transition-all cursor-default">
            <div className="h-12 w-12 rounded-xl bg-green-50 text-green-700 flex items-center justify-center font-black text-xl uppercase">{getInitial(emp.name)}</div>
            <div className="flex-1 overflow-hidden">
              <h4 className="font-black text-slate-800 uppercase truncate leading-none mb-1">{emp.name}</h4>
              <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{emp.id} • {emp.role}</p>
            </div>
            <div className="opacity-0 group-hover:opacity-100 flex gap-2 transition-all">
              <button onClick={() => handleEdit(emp)} className="text-blue-500 p-2 hover:bg-blue-50 rounded-lg"><Pencil size={16}/></button>
              <button onClick={() => onDeleteMember(emp.id)} className="text-red-500 p-2 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}

function PayrollView({ user, employees, onEditEmployee, fetchData, payrollPostedMonths }) {
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
  const [loading, setLoading] = useState(false);

  const isAdmin = user.role === 'admin';
  const isPosted = Array.isArray(payrollPostedMonths) && payrollPostedMonths.some(m => String(m).trim() === String(month).trim());

  const handlePostAction = async (action) => {
    if (!window.confirm(`${action === 'post' ? 'Publish' : 'Unpublish'} payroll for ${month}?`)) return;
    setLoading(true);
    try {
      const endpoint = action === 'post' ? '/payroll-post' : `/payroll-post/${month}`;
      const method = action === 'post' ? 'POST' : 'DELETE';
      const body = action === 'post' ? JSON.stringify({ month }) : null;
      const res = await fetch(API_BASE + endpoint, { method, headers: {'Content-Type': 'application/json'}, body });
      if (res.ok) { notify(`Status: ${action === 'post' ? 'Broadcast Published' : 'Month Unpublished'}`); await fetchData(); }
      else alert("Publish command refused.");
    } catch(e) { alert("Matrix Offline."); }
    finally { setLoading(false); }
  };

  const handleIndividualReset = async (id) => {
    if (!window.confirm(`Reset month figures for ${id}?`)) return;
    const emp = employees.find(e => e.id === id);
    if (!emp) return;
    const payload = { ...emp, basic_salary: 0, invigilation: 0, t_payment: 0, increment: 0, tax: 0, loan_deduction: 0, insurance: 0, others_deduction: 0 };
    await onEditEmployee(payload, true);
    await fetchData(); notify("Reset Complete.");
  };

  const handleBulkImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const targetMonth = window.prompt("Confirm target month for import (YYYY-MM):", month);
    if (!targetMonth || !/^\d{4}-\d{2}$/.test(targetMonth)) return alert("Invalid Format.");
    const reader = new FileReader();
    reader.onload = async (evt) => {
        const text = evt.target.result;
        const lines = text.split(/\r?\n/);
        setLoading(true);
        let successCount = 0;
        for (let i = 2; i < lines.length; i++) {
            const cols = parseCSVLine(lines[i]);
            if (cols.length < 5 || !cols[1]) continue;
            const existing = employees.find(emp => String(emp.id).toUpperCase() === String(cols[1]).toUpperCase());
            if (!existing) continue;
            const payload = { ...existing, basic_salary: cleanNumber(cols[4]), invigilation: cleanNumber(cols[5]), t_payment: cleanNumber(cols[6]), increment: cleanNumber(cols[7]), extra_leaves_deduction: cleanNumber(cols[9]), tax: cleanNumber(cols[10]), loan_deduction: cleanNumber(cols[11]), insurance: cleanNumber(cols[12]), others_deduction: cleanNumber(cols[13]) };
            await onEditEmployee(payload, true); successCount++;
        }
        await fetchData(); alert(`Import Processed: ${successCount} Records.`); setLoading(false);
    };
    reader.readAsText(file);
  };

  const downloadSlip = () => {
    const emp = employees.find(e => e.id === user.id) || user;
    const m = calculateSalaryMetrics(emp);
    const monthName = new Date(month).toLocaleString('default', { month: 'long', year: 'numeric' });
    
    const html = `
      <div style="padding: 40px; font-family: sans-serif; background: white;">
        <div style="text-align: center; border-bottom: 3px solid #15803d; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin: 0; color: #15803d; text-transform: uppercase; font-size: 24px; font-weight: 900;">The University of Lahore</h1>
            <p style="margin: 5px 0; font-weight: 800; color: #64748b; text-transform: uppercase; font-size: 11px; letter-spacing: 2px;">City Campus Lahore</p>
            <div style="display: inline-block; background: #f1f5f9; padding: 5px 20px; border-radius: 50px; margin-top: 15px;">
                <h2 style="margin: 0; text-transform: uppercase; font-size: 12px; font-weight: 900; color: #1e293b;">Salary Slip - ${monthName}</h2>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 40px; font-size: 13px;">
            <div>
                <p style="margin: 3px 0;"><strong>Employee Name:</strong> <span style="text-transform: uppercase;">${emp.name}</span></p>
                <p style="margin: 3px 0;"><strong>Employee Code:</strong> ${emp.id}</p>
            </div>
            <div style="text-align: right;">
                <p style="margin: 3px 0;"><strong>Identity:</strong> ${emp.role.toUpperCase()}</p>
                <p style="margin: 3px 0;"><strong>Printed:</strong> ${getPktDate()}</p>
            </div>
        </div>

        <div style="display: flex; gap: 30px;">
            <div style="flex: 1;">
                <h3 style="background: #f8fafc; padding: 10px; font-size: 11px; text-transform: uppercase; border-left: 4px solid #15803d; font-weight: 900;">Earnings</h3>
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Basic Salary</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.basic_salary).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Invigilation</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.invigilation).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">T. Payment</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.t_payment).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Increment</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.increment).toLocaleString()}</td></tr>
                    <tr style="font-weight: 900; background: #fdfdfd;"><td style="padding: 15px 5px;">Gross Total</td><td style="text-align: right;">PKR ${m.totalAddition.toLocaleString()}</td></tr>
                </table>
            </div>
            <div style="flex: 1;">
                <h3 style="background: #fef2f2; padding: 10px; font-size: 11px; text-transform: uppercase; border-left: 4px solid #ef4444; font-weight: 900;">Deductions</h3>
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Extra Leaves</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.extra_leaves_deduction).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Income Tax</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.tax).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Loan Recovery</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.loan_deduction).toLocaleString()}</td></tr>
                    <tr><td style="padding: 10px 5px; border-bottom: 1px solid #f1f5f9;">Insurance</td><td style="text-align: right; font-weight: 700;">${cleanNumber(emp.insurance).toLocaleString()}</td></tr>
                    <tr style="font-weight: 900; color: #ef4444;"><td style="padding: 15px 5px;">Total Deductions</td><td style="text-align: right;">PKR ${m.totalDeduction.toLocaleString()}</td></tr>
                </table>
            </div>
        </div>

        <div style="margin-top: 50px; padding: 25px; background: #15803d; color: white; border-radius: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 16px; text-transform: uppercase; font-weight: 800;">Net Salary Paid</h2>
            <h1 style="margin: 0; font-size: 32px; font-weight: 900;">PKR ${m.netPaid.toLocaleString()}</h1>
        </div>

        <div style="margin-top: 100px; display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 220px; border-top: 1px solid #e2e8f0; padding-top: 12px; font-size: 11px; color: #64748b; font-weight: 800; text-transform: uppercase;">Employee Signature</div>
            <div style="text-align: center; width: 220px; border-top: 1px solid #e2e8f0; padding-top: 12px; font-size: 11px; color: #64748b; font-weight: 800; text-transform: uppercase;">Authorized Registrar</div>
        </div>
      </div>
    `;
    
    const el = document.getElementById('pdf-template');
    el.innerHTML = html;
    el.style.display = 'block';

    setTimeout(() => {
      const options = { margin: 0, filename: `LSAF_PaySlip_${emp.id}_${month}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
      html2pdf().set(options).from(el).save().then(() => { el.style.display = 'none'; });
    }, 800);
  };

  const downloadTemplate = () => {
    const headers = "Sr.No,Code,Name,DOJ,Salary & Wages,Invigilation,T.payment,Increament,Total Addition, Extra Leaves ,Tax,Loan,Insurance 7,others,Total Deduction,Total salary Paid";
    const row = "1,EMP001,Example Name,2025-01-01,60000,0,0,0,60000,0,0,0,0,0,0,60000";
    const csvContent = "data:text/csv;charset=utf-8," + "University of Lahore Salary Template\n" + headers + "\n" + row;
    const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "LSAF_Import_Template.csv"); link.click();
  };

  const displayList = isAdmin ? employees : [employees.find(e => e.id === user.id) || user];

  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="flex flex-col md:flex-row justify-between items-center gap-4">
        <h2 className="text-xl font-black uppercase tracking-tighter">Salary Management</h2>
        <div className="flex flex-wrap gap-2 justify-center">
          <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="p-2 border-2 rounded-xl font-black bg-white shadow-sm outline-none" />
          {isAdmin ? (
            <>
              <Button variant={isPosted ? 'danger' : 'primary'} onClick={() => handlePostAction(isPosted ? 'unpost' : 'post')} disabled={loading}>{isPosted ? 'Unpublish' : 'Publish Data'}</Button>
              <Button variant="secondary" onClick={downloadTemplate} icon={FileSpreadsheet}>Template</Button>
              <label className="bg-white border-2 px-4 py-2 rounded-xl font-bold text-xs uppercase cursor-pointer hover:bg-slate-50 transition-all flex items-center gap-2"><Upload size={16}/> Import <input type="file" className="hidden" onChange={handleBulkImport} /></label>
              <Button variant="secondary" icon={Download} onClick={() => exportToCSV(employees.map(e => ({id: e.id, name: e.name, basic: e.basic_salary, net: calculateSalaryMetrics(e).netPaid})), 'LSAF_Export.csv')}>Export</Button>
            </>
          ) : (
            <Button icon={FileText} onClick={downloadSlip}>Download PDF Slip</Button>
          )}
        </div>
      </div>

      {!isAdmin && !isPosted ? (
        <Card className="text-center py-40 border-none shadow-sm">
          <Lock size={64} className="mx-auto text-slate-200 mb-4" />
          <h3 className="text-xl font-black text-slate-400 uppercase tracking-widest">Period Locked</h3>
          <p className="text-sm text-slate-400">The salary ledger for {month} has not been authorized by HR.</p>
        </Card>
      ) : (
        <div className="overflow-x-auto rounded-[2rem] border-2 border-slate-100 bg-white shadow-xl">
          <table className="w-full text-left text-[10px]">
            <thead className="bg-slate-50 border-b font-black text-slate-400 uppercase tracking-widest">
              <tr>
                <th className="p-4">ID</th><th className="p-4">Staff</th>
                <th className="p-4 text-right">Basic</th><th className="p-4 text-right">Invig</th>
                <th className="p-4 text-right">T.Pay</th><th className="p-4 text-right">Incr</th>
                <th className="p-4 text-right">Others</th>
                <th className="p-4 text-right font-black text-slate-900 uppercase">Net Pay</th>
                {isAdmin && <th className="p-4 text-center">Action</th>}
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-50 font-bold">
              {displayList.map(emp => {
                const isEditing = editingId === emp.id;
                const target = isEditing ? editForm : emp;
                const m = calculateSalaryMetrics(target);
                return (
                  <tr key={emp.id} className="hover:bg-slate-50/50 transition-colors">
                    <td className="p-4 font-black text-slate-900">{emp.id}</td>
                    <td className="p-4 uppercase truncate max-w-[150px]">{emp.name}</td>
                    <td className="p-4 text-right">{isEditing ? <input type="number" className="w-20 p-1 border rounded" value={editForm.basic_salary} onChange={e => setEditForm({...editForm, basic_salary: e.target.value})}/> : cleanNumber(emp.basic_salary).toLocaleString()}</td>
                    <td className="p-4 text-right">{isEditing ? <input type="number" className="w-16 p-1 border rounded" value={editForm.invigilation} onChange={e => setEditForm({...editForm, invigilation: e.target.value})}/> : cleanNumber(emp.invigilation).toLocaleString()}</td>
                    <td className="p-4 text-right">{isEditing ? <input type="number" className="w-16 p-1 border rounded" value={editForm.t_payment} onChange={e => setEditForm({...editForm, t_payment: e.target.value})}/> : cleanNumber(emp.t_payment).toLocaleString()}</td>
                    <td className="p-4 text-right">{isEditing ? <input type="number" className="w-16 p-1 border rounded" value={editForm.increment} onChange={e => setEditForm({...editForm, increment: e.target.value})}/> : cleanNumber(emp.increment).toLocaleString()}</td>
                    <td className="p-4 text-right font-mono text-slate-500">{cleanNumber(emp.others_deduction).toLocaleString()}</td>
                    <td className="p-4 text-right font-black text-slate-900">Rs. {m.netPaid.toLocaleString()}</td>
                    {isAdmin && (
                      <td className="p-4 text-center">
                        <div className="flex items-center justify-center gap-2">
                           {isEditing ? (
                             <button onClick={async () => { await onEditEmployee(editForm, true); setEditingId(null); await fetchData(); }} className="bg-green-600 text-white px-2 py-0.5 rounded text-[8px]">SAVE</button>
                           ) : (
                             <>
                               <button onClick={() => { setEditingId(emp.id); setEditForm({...emp}); }} className="text-blue-500 p-1 hover:bg-blue-50 rounded"><Pencil size={14}/></button>
                               <button onClick={() => handleIndividualReset(emp.id)} className="text-red-400 p-1 hover:bg-red-50 rounded"><Trash2 size={14}/></button>
                             </>
                           )}
                        </div>
                      </td>
                    )}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

function AttendanceView({ history, onClockAction, user }) {
  const [loading, setLoading] = useState(false);
  const handleAction = (type) => {
    setLoading(true);
    navigator.geolocation.getCurrentPosition(async (pos) => { 
        try { await onClockAction(type, pos.coords); notify(`${type} Verified.`); } 
        catch (e) { alert("GPS Lock Error."); } finally { setLoading(false); } 
    }, () => { alert("Location Denied."); setLoading(false); });
  };
  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <h2 className="text-xl font-black uppercase tracking-widest border-b pb-4">Attendance Verification</h2>
      <div className="grid md:grid-cols-2 gap-6">
        <Card className="py-12 flex flex-col items-center justify-center space-y-6 border-2 shadow-inner bg-slate-50/50">
          <h3 className="text-5xl font-black text-slate-800 font-mono tracking-tighter">{getPktTime()}</h3>
          <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{getPktDate()}</p>
          <div className="w-full max-w-xs space-y-3 pt-4">
            <button onClick={() => handleAction('Clock In')} disabled={loading} className="w-full py-4 rounded-2xl bg-green-700 text-white font-black shadow-lg hover:bg-green-800 transition-all active:scale-95">Clock In</button>
            <button onClick={() => handleAction('Clock Out')} disabled={loading} className="w-full py-4 rounded-2xl bg-white border-2 text-slate-700 font-black hover:bg-slate-50 transition-all active:scale-95">Clock Out</button>
          </div>
        </Card>
        <Card className="flex items-center justify-center p-8 bg-white border-dashed border-2 text-center rounded-[2rem] border-slate-200">
            <div><MapPin className="text-green-600 mx-auto mb-4 animate-bounce" size={40} /><p className="text-xs font-black text-slate-500 uppercase tracking-widest leading-relaxed">Geofence Matrix Active</p></div>
        </Card>
      </div>
      
      <div className="mt-8 overflow-hidden rounded-2xl border bg-white">
        <div className="bg-slate-50 p-4 border-b font-black text-[10px] uppercase text-slate-400">Activity Logs (Historical)</div>
        <div className="divide-y max-h-64 overflow-y-auto custom-scrollbar">
          {history.map((log, i) => (
            <div key={i} className="p-4 flex justify-between items-center hover:bg-slate-50">
              <div><p className="text-xs font-black uppercase">{log.type}</p><p className="text-[10px] text-slate-400">{formatDate(log.date_str)}</p></div>
              <p className="font-mono text-xs font-bold text-slate-500">{log.time_str}</p>
            </div>
          ))}
          {history.length === 0 && <p className="p-8 text-center text-slate-300 font-black uppercase text-[10px]">No Records Sync'd</p>}
        </div>
      </div>
    </div>
  );
}

function LeavesView({ leaves, onApplyLeave, user }) {
  const [tab, setTab] = useState('apply');
  const [formData, setFormData] = useState({ type: 'Annual Leave', startDate: '', days: 1, reason: '' });
  const submitAction = async (e) => { e.preventDefault(); await onApplyLeave({ ...formData, employeeId: user.id }); notify("Application Dispatched."); setTab('history'); };
  const list = Array.isArray(leaves) ? leaves : [];
  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="flex bg-slate-200 p-1 rounded-2xl max-w-xs mx-auto mb-8 shadow-inner">
        <button onClick={() => setTab('apply')} className={"flex-1 py-2 text-[10px] font-black rounded-xl uppercase transition-all " + (tab === 'apply' ? 'bg-white shadow-md text-green-700' : 'text-slate-500')}>Apply</button>
        <button onClick={() => setTab('history')} className={"flex-1 py-2 text-[10px] font-black rounded-xl uppercase transition-all " + (tab === 'history' ? 'bg-white shadow-md text-green-700' : 'text-slate-500')}>Archive</button>
      </div>
      {tab === 'apply' ? (
        <Card className="max-w-xl mx-auto shadow-2xl !p-10 border-green-50 border-2">
          <form onSubmit={submitAction} className="space-y-6">
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Type</label>
              <select className="w-full p-4 rounded-xl border-2 font-black bg-slate-50" value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})}>
                <option>Annual Leave</option><option>Sick Leave</option><option>WOP Leave</option>
              </select>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1">
                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Start Date</label>
                <input type="date" className="w-full p-4 rounded-xl border-2 font-black bg-slate-50" value={formData.startDate} onChange={(e) => setFormData({...formData, startDate: e.target.value})} required />
              </div>
              <div className="space-y-1">
                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Days</label>
                <input type="number" className="w-full p-4 rounded-xl border-2 font-black bg-slate-50" placeholder="1" value={formData.days} onChange={(e) => setFormData({...formData, days: e.target.value})} required />
              </div>
            </div>
            <div className="space-y-1">
              <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Reason / Justification</label>
              <textarea className="w-full p-4 rounded-xl border-2 font-bold h-32 bg-slate-50" placeholder="Describe the purpose of your leave..." value={formData.reason} onChange={(e) => setFormData({...formData, reason: e.target.value})} required></textarea>
            </div>
            <Button type="submit" className="w-full py-4 text-base uppercase tracking-widest">Confirm Application</Button>
          </form>
        </Card>
      ) : (
        <div className="space-y-4 max-w-2xl mx-auto">
          {list.map((item, i) => (
            <Card key={i} className="flex justify-between items-center !p-6 border-2 hover:border-green-100 transition-all">
              <div><h4 className="font-black uppercase text-slate-800 text-lg">{item.leave_type}</h4><p className="text-xs text-slate-400 font-bold uppercase tracking-tighter mt-1">{formatDate(item.start_date)} • {item.days} Days</p></div>
              <Badge status={item.status} />
            </Card>
          ))}
          {list.length === 0 && <p className="text-center text-slate-300 font-black uppercase text-xs pt-20">Identity has no historical leave records</p>}
        </div>
      )}
    </div>
  );
}

function LoansView({ loans, onApplyLoan, user }) {
  const [isOpen, setIsOpen] = useState(false);
  const [form, setForm] = useState({ amount: '', reason: '' });
  const isAdmin = user.role === 'admin';

  const submit = async (e) => {
    e.preventDefault();
    await onApplyLoan({ employeeId: user.id, totalAmount: form.amount, reason: form.reason });
    setIsOpen(false); setForm({ amount: '', reason: '' }); notify("Loan Request Logged.");
  };

  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="flex justify-between items-center border-b pb-4 border-slate-100">
        <h2 className="text-xl font-black uppercase tracking-tighter">Loan Hub</h2>
        {!isAdmin && <Button onClick={() => setIsOpen(true)} icon={Wallet}>Apply for Loan</Button>}
      </div>

      {isOpen && (
        <Card className="max-w-xl mx-auto border-2 border-amber-100">
          <form onSubmit={submit} className="space-y-6">
            <input type="number" className="w-full p-4 rounded-xl border-2 font-black bg-slate-50" placeholder="Principal Amount (PKR)" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} required />
            <textarea className="w-full p-4 rounded-xl border-2 font-bold h-32 bg-slate-50" placeholder="Loan Justification..." value={form.reason} onChange={e => setForm({...form, reason: e.target.value})} required></textarea>
            <div className="flex justify-end gap-3 pt-4 border-t">
               <Button variant="ghost" onClick={() => setIsOpen(false)}>Discard</Button>
               <Button type="submit">Submit Request</Button>
            </div>
          </form>
        </Card>
      )}

      <div className="grid gap-4">
        {loans.filter(l => isAdmin || l.employee_id === user.id).map((l, i) => (
          <Card key={i} className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 border hover:border-amber-400 transition-all">
            <div>
              <h4 className="font-black uppercase text-slate-800 text-lg">{l.employee_name || 'Staff Member'}</h4>
              <p className="text-xs text-slate-400 italic">"{l.reason}"</p>
            </div>
            <div className="flex gap-8 text-right shrink-0">
               <div><p className="text-[10px] font-black uppercase text-slate-400">Total Grant</p><p className="font-black text-slate-800">Rs. {cleanNumber(l.total_amount).toLocaleString()}</p></div>
               <div><p className="text-[10px] font-black uppercase text-slate-400">Current Balance</p><p className="font-black text-red-600">Rs. {(cleanNumber(l.total_amount) - cleanNumber(l.paid_amount)).toLocaleString()}</p></div>
               <div className="self-center"><Badge status={l.status}/></div>
            </div>
          </Card>
        ))}
        {loans.length === 0 && <p className="text-center text-slate-300 font-black uppercase text-xs pt-20 tracking-widest">No loan data available in current cycle</p>}
      </div>
    </div>
  );
}

function DiscussionView({ discussions, user, onPost }) {
  const [isOpen, setIsOpen] = useState(false);
  const [form, setForm] = useState({ title: '', msg: '' });
  const isAdmin = user.role === 'admin';

  const submit = async (e) => {
    e.preventDefault();
    await onPost({ title: form.title, message: form.msg, senderName: user.name, senderId: user.id, date: new Date().toISOString() });
    setIsOpen(false); setForm({ title: '', msg: '' }); notify("Broadcast Published.");
  };

  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="flex justify-between items-center border-b pb-4 border-slate-100">
        <h2 className="text-xl font-black uppercase tracking-tighter">Global Board</h2>
        {isAdmin && <Button onClick={() => setIsOpen(true)} icon={Send}>New Broadcast</Button>}
      </div>

      {isOpen && (
        <Card className="max-w-2xl mx-auto border-2 border-green-100 animate-slide-up">
           <form onSubmit={submit} className="space-y-4">
              <input type="text" className="w-full p-4 rounded-xl border-2 font-black" placeholder="Header Title" value={form.title} onChange={e => setForm({...form, title: e.target.value})} required />
              <textarea className="w-full p-4 rounded-xl border-2 font-medium h-32" placeholder="Content Body..." value={form.msg} onChange={e => setForm({...form, msg: e.target.value})} required></textarea>
              <div className="flex justify-end gap-3">
                 <Button variant="ghost" onClick={() => setIsOpen(false)}>Discard</Button>
                 <Button type="submit">Publish</Button>
              </div>
           </form>
        </Card>
      )}

      <div className="space-y-6 max-w-4xl mx-auto">
        {discussions.map((d, i) => (
          <Card key={i} className="border-l-[10px] border-l-green-600 shadow-lg !p-8 relative hover:border-green-300 transition-all">
            <div className="flex justify-between items-start mb-2">
              <h4 className="font-black text-xl text-slate-800 uppercase leading-tight">{d.title}</h4>
              <span className="text-[10px] font-black text-slate-300 uppercase whitespace-nowrap">{formatDate(d.date)}</span>
            </div>
            <p className="text-slate-600 text-lg leading-relaxed mb-6 border-b pb-6 border-slate-50">{d.message}</p>
            <div className="flex justify-between items-center">
               <span className="bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-black uppercase">Verified: {d.senderName}</span>
               <button className="text-blue-600 text-xs font-black uppercase tracking-widest flex items-center gap-2 hover:underline"><Reply size={14}/> Post Response</button>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}

function SettingsView() {
  return (
    <div className="space-y-6 animate-fade-in text-center py-20">
       <ShieldAlert size={64} className="mx-auto text-slate-200 mb-4" />
       <h2 className="text-2xl font-black uppercase tracking-tight text-slate-400">Security Matrix</h2>
       <Card className="max-w-md mx-auto space-y-6 !p-10 border shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-full blur-3xl -mr-16 -mt-16 opacity-50"></div>
          <div className="relative z-10 space-y-4">
             <div className="h-16 w-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center mx-auto shadow-xl"><Key size={32}/></div>
             <div className="space-y-2">
                <input type="password" placeholder="Current Password" className="w-full p-4 rounded-xl border-2 font-black bg-slate-50 outline-none" />
                <input type="password" placeholder="New Password" className="w-full p-4 rounded-xl border-2 font-black bg-slate-50 outline-none" />
             </div>
             <Button className="w-full py-4 bg-slate-900" onClick={() => notify("Access Key Synced.")}>Synchronize Key</Button>
          </div>
       </Card>
    </div>
  );
}

/**
 * MAIN ORCHESTRATION
 */
export default function App() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [employees, setEmployees] = useState([]);
  const [history, setHistory] = useState([]);
  const [loans, setLoans] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [discussions, setDiscussions] = useState([]);
  const [payrollPostedMonths, setPayrollPostedMonths] = useState([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(() => {
    try { const saved = localStorage.getItem('hr_user'); return saved ? JSON.parse(saved) : null; } catch(e) { return null; }
  });

  const syncState = async () => {
    try {
      const [eRes, pRes, lRes, dRes] = await Promise.all([
        fetch(API_BASE + '/employees'),
        fetch(API_BASE + '/payroll-posted'),
        fetch(API_BASE + '/loans'),
        fetch(API_BASE + '/discussions')
      ]);
      if (eRes.ok) setEmployees(await eRes.json());
      if (pRes.ok) setPayrollPostedMonths(await pRes.json());
      if (lRes.ok) setLoans(await lRes.json());
      if (dRes.ok) setDiscussions(await dRes.json());
    } catch (e) { console.error("Sync Error."); }
    finally { setLoading(false); }
  };

  useEffect(() => { syncState(); }, []);

  useEffect(() => {
    if (user?.id) {
      const loadLocal = async () => {
        try {
          const aRes = await fetch(API_BASE + '/attendance/' + user.id);
          if (aRes.ok) setHistory(await aRes.json());
          const lvRes = await fetch(API_BASE + '/leaves/' + user.id);
          if (lvRes.ok) setLeaves(await lvRes.json());
        } catch (e) {}
      };
      loadLocal();
    }
  }, [user?.id]);

  const authHandle = async (id, password) => {
    setLoading(true);
    try {
      const res = await fetch(API_BASE + '/employees');
      const list = await res.json();
      const normalizedId = String(id).trim().toUpperCase();
      const found = list.find(e => String(e.id).toUpperCase() === normalizedId && String(e.password) === String(password));
      if (found) {
        setUser(found); 
        localStorage.setItem('hr_user', JSON.stringify(found)); 
        await syncState();
        if (found.role !== 'admin' && payrollPostedMonths.length > 0) {
            const sorted = [...payrollPostedMonths].sort((a,b) => (b.month_year || b).localeCompare(a.month_year || a));
            // Force state refresh
        }
      } else alert("Invalid Credentials.");
    } catch (e) { alert("Identity Server Offline."); } 
    finally { setLoading(false); }
  };

  const deleteMember = async (id) => {
    if(!window.confirm("Permanently wipe identity?")) return;
    await fetch(`${API_BASE}/employees/${id}`, { method: 'DELETE' });
    await syncState();
  };

  const updateProfile = async (data, silent = false) => {
    try {
      const res = await fetch(API_BASE + '/employees/' + data.id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      if (res.ok) { if(!silent) await syncState(); return true; }
    } catch (e) { return false; }
  };

  if (loading && !user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-white flex-col gap-6 text-slate-300 font-black uppercase tracking-[0.6em] animate-pulse">
        <Activity className="animate-spin text-green-700" size={64} />
        Syncing LSAF CORE
      </div>
    );
  }

  if (!user) return <ErrorBoundary><LoginView onLogin={authHandle} loading={loading} /></ErrorBoundary>;
  
  const vUser = employees.find(e => String(e.id).toUpperCase() === String(user.id).toUpperCase()) || user;
  
  const navs = [
    { id: 'dashboard', icon: Home, label: 'Home' }, 
    { id: 'attendance', icon: Clock, label: 'Clock' }, 
    { id: 'payroll', icon: DollarSign, label: 'Salary Hub' }, 
    { id: 'directory', icon: Users, label: 'Staff Hub', admin: true }, 
    { id: 'loans', icon: Wallet, label: 'Loans' }, 
    { id: 'leaves', icon: Calendar, label: 'Leaves' },
    { id: 'discussion', icon: MessageSquare, label: 'Board' },
    { id: 'settings', icon: Shield, label: 'Security' }
  ].filter(item => !item.admin || vUser?.role === 'admin');

  function getTab() {
    switch(currentView) {
      case 'dashboard': return <DashboardView user={vUser} history={history} />;
      case 'attendance': return <AttendanceView history={history} onClockAction={async (type, c) => { await fetch(API_BASE + '/attendance', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ employeeId: user.id, type, date: getPktDate(), time: getPktTime(), lat: c.latitude, lng: c.longitude })}); syncState(); }} user={vUser} />;
      case 'payroll': return <PayrollView user={vUser} employees={employees} onEditEmployee={updateProfile} fetchData={syncState} payrollPostedMonths={payrollPostedMonths} />;
      case 'directory': return <DirectoryView employees={employees} onAddMember={async d => { await fetch(API_BASE+'/employees', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); syncState(); }} onEditMember={updateProfile} onDeleteMember={deleteMember} />;
      case 'loans': return <LoansView loans={loans} user={vUser} onApplyLoan={async d => { await fetch(API_BASE+'/loans', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); syncState(); }} />;
      case 'leaves': return <LeavesView leaves={leaves} user={vUser} onApplyLeave={async d => { await fetch(API_BASE + '/leaves', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); syncState(); }} />;
      case 'discussion': return <DiscussionView discussions={discussions} user={vUser} onPost={async d => { await fetch(API_BASE+'/discussions', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); syncState(); }} />;
      case 'settings': return <SettingsView />;
      default: return <DashboardView user={vUser} history={history} />;
    }
  }

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900 overflow-x-hidden">
        <div id="pdf-template" className="hidden"></div>
        
        {/* Sidebar */}
        <aside className="hidden md:flex flex-col w-64 bg-white border-r fixed h-full z-30 shadow-sm border-slate-100">
          <div className="p-8 border-b flex flex-col items-center">
             <img src={LOGO_URL} alt="Logo" className="h-10 w-full object-contain mb-2" />
             <span className="text-[9px] font-black text-green-700 uppercase tracking-[0.2em]">NexusHR Terminal</span>
          </div>
          <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
            {navs.map(item => (
              <button key={item.id} onClick={() => { setCurrentView(item.id); }} className={"w-full flex items-center gap-4 px-4 py-4 rounded-2xl transition-all font-bold " + (currentView === item.id ? 'bg-green-700 text-white shadow-xl scale-105' : 'text-slate-500 hover:bg-slate-50')}>
                <item.icon size={20} /> <span className="text-xs uppercase tracking-wider">{item.label}</span>
              </button>
            ))}
          </nav>
          <div className="p-5 border-t flex items-center justify-between bg-slate-50/50">
            <div className="flex items-center gap-3 overflow-hidden">
               <div className="h-9 w-9 rounded-xl bg-green-100 flex items-center justify-center text-green-700 font-black border-2 border-white shadow-sm">{getInitial(vUser.name)}</div>
               <div className="flex flex-col overflow-hidden">
                  <span className="text-[11px] font-black truncate uppercase">{vUser.name}</span>
                  <span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">{vUser.role}</span>
               </div>
            </div>
            <button onClick={() => { localStorage.removeItem('hr_user'); window.location.reload(); }} className="text-red-500 hover:bg-red-50 p-2 rounded-xl transition-all"><LogOut size={20} /></button>
          </div>
        </aside>

        {/* Mobile Navigation */}
        <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-2 flex justify-around items-center z-50 rounded-t-[2.5rem] shadow-2xl">
          {navs.slice(0, 5).map(item => (
            <button key={item.id} onClick={() => setCurrentView(item.id)} className={"p-4 rounded-2xl transition-all " + (currentView === item.id ? 'bg-green-50 text-green-700 scale-110 shadow-inner' : 'text-slate-400')}>
              <item.icon size={24} />
            </button>
          ))}
        </nav>

        {/* Main Content */}
        <main className="flex-1 md:ml-64 p-4 md:p-10 pb-24 lg:pb-10 min-h-screen">
            <div className="max-w-6xl mx-auto">{getTab()}</div>
        </main>
      </div>
    </ErrorBoundary>
  );
}
